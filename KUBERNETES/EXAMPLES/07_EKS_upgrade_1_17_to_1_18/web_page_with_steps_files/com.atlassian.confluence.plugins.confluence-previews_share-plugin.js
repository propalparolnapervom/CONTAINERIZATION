WRMCB=function(e){var c=console;if(c&&c.log&&c.error){c.log('Error running batched script.');c.error(e);}}
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:share-plugin', location = '/templates/share-button.soy' */
// This file was automatically generated from share-button.soy.
// Please don't edit this file by hand.

/**
 * @fileoverview Templates in namespace FileViewer.Templates.
 */

if (typeof FileViewer == 'undefined') { var FileViewer = {}; }
if (typeof FileViewer.Templates == 'undefined') { FileViewer.Templates = {}; }


FileViewer.Templates.controlShareButton = function(opt_data, opt_ignored) {
  return '<a id="cp-control-panel-share" href="#" title="' + soy.$$escapeHtml('Share') + '" class="cp-icon"></a>';
};
if (goog.DEBUG) {
  FileViewer.Templates.controlShareButton.soyTemplateName = 'FileViewer.Templates.controlShareButton';
}


FileViewer.Templates.sharePreviewPopup = function(opt_data, opt_ignored) {
  return '<form action="#" method="post" class="aui share-content-popup"><div class="field-group"><div class="autocomplete-user-target"><input class="text autocomplete-sharepage" id="users" data-max="10" data-dropdown-target=".autocomplete-user-target" data-none-message="' + soy.$$escapeHtml('No matches') + '" placeholder="' + soy.$$escapeHtml('User name, group or email') + '"/></div><ol class="recipients"></ol></div><div class="field-group"><textarea class="textarea" id="note" placeholder="' + soy.$$escapeHtml('Add an optional note') + '"/></div><div class="field-group button-panel"><div class="progress-messages-icon"></div><div class="progress-messages"></div><input class="button submit" type="submit" value="' + soy.$$escapeHtml('Share') + '" disabled/><a class="close-dialog" href="#">' + soy.$$escapeHtml('Cancel') + '</a></div></form>';
};
if (goog.DEBUG) {
  FileViewer.Templates.sharePreviewPopup.soyTemplateName = 'FileViewer.Templates.sharePreviewPopup';
}


FileViewer.Templates.recipientUser = function(opt_data, opt_ignored) {
  return '<li data-userkey="' + soy.$$escapeHtml(opt_data.userKey) + '" style="display: none" class="recipient-user"><img src="' + soy.$$escapeHtml(opt_data.thumbnailLink.href) + '" title="' + soy.$$escapeHtml(opt_data.title) + '"/><span class="title" title="' + soy.$$escapeHtml(opt_data.title) + '">' + soy.$$escapeHtml(opt_data.title) + '</span><span class="remove-recipient"/></li>';
};
if (goog.DEBUG) {
  FileViewer.Templates.recipientUser.soyTemplateName = 'FileViewer.Templates.recipientUser';
}


FileViewer.Templates.recipientEmail = function(opt_data, opt_ignored) {
  return '<li data-email="' + soy.$$escapeHtml(opt_data.email) + '" style="display: none" class="recipient-email"><img src="' + soy.$$escapeHtml(opt_data.icon) + '" title="' + soy.$$escapeHtml(opt_data.email) + '"/><span class="title" title="' + soy.$$escapeHtml(opt_data.email) + '">' + soy.$$escapeHtml(opt_data.email) + '</span><span class="remove-recipient"/></li>';
};
if (goog.DEBUG) {
  FileViewer.Templates.recipientEmail.soyTemplateName = 'FileViewer.Templates.recipientEmail';
}


FileViewer.Templates.recipientGroup = function(opt_data, opt_ignored) {
  return '<li data-group="' + soy.$$escapeHtml(opt_data.title) + '" style="display: none" class="recipient-group"><span><img src="' + soy.$$escapeHtml(opt_data.thumbnailLink.href) + '" title="' + soy.$$escapeHtml(opt_data.title) + '"/><span>' + soy.$$escapeHtml(opt_data.title) + '</span><span class="remove-recipient"/></span></li>';
};
if (goog.DEBUG) {
  FileViewer.Templates.recipientGroup.soyTemplateName = 'FileViewer.Templates.recipientGroup';
}

}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:share-plugin', location = '/js/component/share-button/share-button-plugin.js' */
define("cp/component/share-button/share-button-plugin",["jquery","ajs","backbone","MediaViewer","core/template-store-singleton"],function(f,h,i,b,j){var a={};a.autocompleteUser=function(n){n=n||document.body;var o=h.$,k=/^([a-zA-Z0-9_\.\-\+\!#\$%&'\*/=\?\^_`{|}~])+\@.*/;var m=function(s){if(!s||!s.result){throw new Error("Invalid JSON format")}var p=[];for(var q=0;q<s.result.length;q++){var r=s.result[q];if(r.type=="group"){r=l(r)}}p.push(s.result);return p};function l(p){if(p.name=="confluence-users"||p.name=="confluence-administrators"){return p}p.title=p.name;p.group=p.name;p.thumbnailLink={href:h.contextPath()+"/download/resources/com.atlassian.confluence.plugins.share-page:mail-page-resources/images/group.png",type:"image/png",rel:"thumbnail"};p.link=[{href:h.contextPath(),rel:"self"}];return p}o("input.autocomplete-sharepage[data-autocomplete-user-bound!=true]",n).each(function(){var r=o(this).attr("data-autocomplete-sharepage-bound","true").attr("autocomplete","off");var q=r.attr("data-max")||10,t=r.attr("data-alignment")||"left",s=r.attr("data-dropdown-target"),p=null;if(s){p=o(s)}else{p=o("<div></div>");r.after(p)}p.addClass("aui-dd-parent autocomplete");r.quicksearch(h.REST.getBaseUrl()+"search/user-or-group.json",function(){r.trigger("open.autocomplete-sharepage")},{makeParams:function(u){return{"max-results":q,query:u.replace("{|}","")}},dropdownPlacement:function(u){p.append(u)},makeRestMatrixFromData:m,addDropdownData:function(v){var u=o.trim(r.val());if(k.test(u)){v.push([{name:u,email:u,href:"#",icon:h.contextPath()+"/download/resources/com.atlassian.confluence.plugins.share-page:mail-page-resources/images/envelope.png"}])}if(!v.length){var w=r.attr("data-none-message");if(w){v.push([{name:w,className:"no-results",href:"#"}])}}return v},ajsDropDownOptions:{alignment:t,displayHandler:function(u){if(u.restObj&&u.restObj.username){return u.name+" ("+u.restObj.username+")"}return u.name},selectionHandler:function(w,v){if(v.find(".search-for").length){r.trigger("selected.autocomplete-sharepage",{searchFor:r.val()});return}if(v.find(".no-results").length){this.hide();w.preventDefault();return}var u=o("span:eq(0)",v).data("properties");if(!u.email){u=u.restObj}r.trigger("selected.autocomplete-sharepage",{content:u});this.hide();w.preventDefault()}}})})};var c={width:250,hideDelay:3600000,calculatePositions:function(l,s,A,w){var t;var C;var y;var p=-7;var q;var u;var B=s.target.offset();var k=s.target.outerWidth();var n=B.left+k/2;var x=(window.pageYOffset||document.documentElement.scrollTop)+f(window).height();var o=10;y=B.top+s.target.outerHeight()+w.offsetY;t=B.left+w.offsetX;var r=B.top>l.height();var m=(y+l.height())<x;u=(!m&&r)||(w.onTop&&r);var v=f(window).width()-(t+w.width+o);if(u){y=B.top-l.height()-8;var z=w.displayShadow?(h.$.browser.msie?10:9):0;p=l.height()-z}q=n-t+w.arrowOffsetX;if(w.isRelativeToMouse){if(v<0){C=o;t="auto";q=A.x-(f(window).width()-w.width)}else{t=A.x-20;C="auto";q=A.x-t}}else{if(v<0){C=o;t="auto";q=n-(f(window).width()-l.outerWidth())+o}else{if(w.width<=k/2){q=w.width/2;t=n-w.width/2}}}return{displayAbove:u,popupCss:{left:t,right:C,top:y},arrowCss:{position:"absolute",left:q,right:"auto",top:p}}}};var d=function(s,k,o){var m=function(){var t=a.identifier;var u=t+".inline-dialog-check";f("body").unbind("mousedown."+u)};var r=function(t){this._mediaViewer.getView().unlockNavigationKeys();a.current.hide();m();if(t){setTimeout(function(){s.empty()},300)}return false}.bind(this);var n=function(){var t=a.identifier;var u=t+".inline-dialog-check";f("body").bind("mousedown."+u,function(w){var v=f(w.target);if(v.closest("#inline-dialog-"+t+" .contents").length===0){r()}})};if(s.find("input").length){o();n();return}s.attr("data-fv-allow-focus",1);s.append(j.get("sharePreviewPopup")());a.autocompleteUser();f(document).on("keydown.shareDialogEscape",function(t){if(t.keyCode==27){t.preventDefault();t.stopPropagation();f(document).off("keydown.shareDialogEscape");return false}return true});s.find(".close-dialog").click(function(t){t.preventDefault();r(true)});var p=this._mediaViewer;s.find("form").submit(function(y){y.preventDefault();var w=f(this).closest(".aui-inline-dialog");var A=[],z=[],t=[];w.find(".recipients li").each(function(D,E){var B=f(E).attr("data-userKey");var C=f(E).attr("data-email");var F=f(E).attr("data-group");if(B){A.push(B)}if(C){z.push(C)}if(F){t.push(F)}});if(A.length<=0&&z.length<=0&&t.length<=0){return false}f("button, input, textarea",this).attr("disabled","disabled");w.find(".progress-messages-icon").removeClass("error");w.find(".progress-messages").text("Sending");w.find(".progress-messages").attr("title","Sending");var v=new Spinner({length:3,width:1,radius:3,color:"#666",className:"cp-share-dialog-spinner"}).spin();w.find(".progress-messages-icon").append(v.el);w.find(".progress-messages-icon").css("position","absolute").css("left","0").css("margin-top","3px");w.find(".progress-messages").css("padding-left",20);var u=w.find("#note");var x={users:A,emails:z,groups:t,note:u.hasClass("placeholded")?"":u.val(),entityId:a.attachmentId,contextualPageId:h.Data.get("content-id"),entityType:"attachment"};f.ajax({type:"POST",contentType:"application/json; charset=utf-8",url:h.contextPath()+"/rest/share-page/latest/share",data:JSON.stringify(x),dataType:"text",success:function(){h.trigger("analyticsEvent",{name:"confluence-spaces.previews.share",data:{fileType:p.getCurrentFile().get("type"),attachmentId:p.getCurrentFile().get("id"),isProject:!!(h.Meta.get("space-type")==="project"&&f('[data-internal-id="tab-files"]').length)}});setTimeout(function(){v.stop();w.find(".progress-messages-icon").addClass("done");w.find(".progress-messages").text("Sent");w.find(".progress-messages").attr("title","Sent");setTimeout(function(){w.find(".progress-messages").text("");w.find(".progress-messages-icon").removeClass("done");w.find("#note").val("");w.find("#users").val("");w.find(".recipient-user").remove();w.find(".recipient-email").remove();w.find(".recipient-group").remove();f("button,input,textarea",w).removeAttr("disabled");r()},1000)},500)},error:function(C,B){v.stop();w.find(".progress-messages-icon").addClass("error");w.find(".progress-messages").text("Error sending");w.find(".progress-messages").attr("title","Error sending"+": "+B);f("button,input,textarea",w).removeAttr("disabled")}});return false});var q=s.find("#users");var l=s.find("input.submit");q.bind("selected.autocomplete-sharepage",function(w,v){var x=function(A,z,B){var D=s.find(".recipients"),C,y;C="li[data-"+A+'="'+B[A]+'"]';if(D.find(C).length>0){D.find(C).hide()}else{D.append(z)}y=D.find(C);y.find(".remove-recipient").click(function(){y.remove();if(D.find("li").length==0){l.attr("disabled","true")}a.current.refresh();q.focus();return false});y.fadeIn(200)};var u,t;if(v.content.email){u="email";t=j.get("recipientEmail")(v.content)}else{if(v.content.type=="group"){u="group";t=j.get("recipientGroup")(v.content)}else{u="userKey";t=j.get("recipientUser")(v.content)}}x(u,t,v.content);a.current.refresh();l.removeAttr("disabled");q.val("");return false});q.bind("open.autocomplete-sharepage",function(u,t){if(f("a:not(.no-results)",h.dropDown.current.links).length>0){h.dropDown.current.moveDown()}});q.keypress(function(t){return t.keyCode!=13});f(document).bind("showLayer",function(v,u,t){if(u==="inlineDialog"&&t.popup===a.current){t.popup.find("#users").focus()}});f(k).parents().filter(function(){return this.scrollTop>0}).scrollTop(0);o();n()};var e=i.View.extend({events:{click:"displayShareDialog"},tagName:"span",initialize:function(k){this._mediaViewer=k.mediaViewer},teardown:function(){if(a.current){a.current.remove();a.current=null}},render:function(){this.$el.html(j.get("controlShareButton")());if(f.fn.tooltip){this.$("a").tooltip({gravity:"n"})}return this},displayShareDialog:function(m){m.preventDefault();var l=c||{};l.hideCallback=function(){this._mediaViewer.getView().unlockNavigationKeys()}.bind(this);var k="#cp-control-panel-share";this._mediaViewer.getView().lockNavigationKeys();a.identifier="sharePreviewPopup";a.attachmentId=this._mediaViewer.getCurrentFile().get("id");a.current=h.InlineDialog(k,a.identifier,d.bind(this),l);a.current.show();return}});var g=function(k){if(!k.getConfig().enableShareButton){return}k.getView().fileControlsView.addLayerView("shareButton",e,{weight:2,predicate:function(l){return !l.getCurrentFile().get("isRemoteLink")}})};return g});(function(){var a=require("cp/component/share-button/share-button-plugin");var b=require("MediaViewer");b.registerPlugin("sharebutton",a)})();
}catch(e){WRMCB(e)};