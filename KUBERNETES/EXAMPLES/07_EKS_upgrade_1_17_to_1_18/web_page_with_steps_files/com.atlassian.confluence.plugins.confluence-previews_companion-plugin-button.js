WRMCB=function(e){var c=console;if(c&&c.log&&c.error){c.log('Error running batched script.');c.error(e);}}
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:companion-plugin-button', location = 'js/component/companion/companion-button-view.js' */
define("cp/component/companion/companion-button-view",["jquery","backbone","core/template-store-singleton","cp/component/companion/confluence-companion-interface","cp/component/companion/dialog","aui/inline-dialog2","confluence/api/event"],function(b,g,i,f,a,d,h){var c=window.ADCClient;var e=g.View.extend({events:{click:"launchInlineDialog"},tagName:"span",initialize:function(j){e.currentInstance=this;this._aboutToFocus=null;this.loading=this.loading.bind(this);this.doneLoading=this.doneLoading.bind(this);this.loading()},teardown:function(){if(this.dialog){this.dialog._kill();delete this.dialog}},loading:function(){this._isLoading=true},doneLoading:function(){this._isLoading=false;this.render()},render:function(){if(!this.file&&e.initialFile){this.file=e.initialFile;delete e.initialFile}var j;if(!this._setHtml){this.$el.html(i.get("companionEditButton")());j=this.$el.get(0).querySelector("#app-name");j.addEventListener("click",this.launchFile.bind(this));this._setHtml=true}if(!j){j=this.$el.get(0).querySelector("#app-name")}if(b.fn.tooltip){this.$("a").tooltip({gravity:"n"})}if(!this._inlineDialog){this._inlineDialog=AJS.InlineDialog(this.$el,"noCompanionDialog",function(p,m,r){p.parent().css("z-index",999);p.html(i.get("companionInlineDialog")());var n;var o=p.get(0).querySelector(".download-win");var q=p.get(0).querySelector(".download-mac");o.addEventListener("click",this._startPolling.bind(this,p,true));q.addEventListener("click",this._startPolling.bind(this,p,true));if(navigator.platform.indexOf("Mac")!==-1){n=q}else{if(navigator.platform.indexOf("Win")!==-1){n=o}}if(n){n.classList.add("aui-button-primary");n.parentNode.insertBefore(n,n.parentNode.firstChild)}r();this._startPolling(p)}.bind(this),{closeOnTriggerClick:true,noBind:true,cacheContent:false,})}var l=this.$el.get(0).firstChild;var k=this.$el.find("ul");if(this._isLoading){k.removeClass("apps-list")}else{k.addClass("apps-list")}if(this._isLoading||this.app){k.addClass("connected");k.removeClass("not-connected");clearTimeout(this._focusLauncher)}else{k.addClass("not-connected");k.removeClass("connected");if(!this.app&&(b(l).is(":focus")||this._aboutToFocus!=null)){this._focusLauncher=setTimeout(function(){this.launchInlineDialog();l.blur()}.bind(this),200);clearTimeout(this._aboutToFocus);this._aboutToFocus=null}}if(this.app){j.style.display="block";j.innerHTML=this.app.displayName;h.trigger("analyticsEvent",{name:"confluence-spaces.previews.companion.openWith.show"})}else{j.style.display="none";j.innerHTML=""}if(this.file&&this.file.get("shouldEdit")){h.trigger("analyticsEvent",{name:"confluence-spaces.previews.companion.launchInEditMode",data:{referer:this.file.get("referer")}});this._aboutToFocus=setTimeout(function(){l.focus();this._aboutToFocus=null}.bind(this),100);if(!this._isLoading){this.file.attributes.shouldEdit=false}}return this},setMeta:function(k,j,n,l,m){this.mediaViewer=k;this.client=j;this.transaction=n;this.file=l;this.app=m;this.render();if(this._onMeta){this._onMeta();this._onMeta=null}},clearMeta:function(){this.setMeta(null,null,null,this.file||null,null)},launchInlineDialog:function(j){if(!this.app&&!this._isLoading){if(this._inlineDialog){this._inlineDialog.show(j)}}},launchFile:function(k){k.preventDefault();if(!this.app){return}var j;this.transaction.on("request-upload-token",function(l,m){f.getUploadTokenFromFile(this.file,function(n){m(n)})}.bind(this));this.dialog=new a({mediaViewer:this.mediaViewer,file:this.file,app:this.app,transaction:this.transaction,confirmSave:function(){f.registerNewVersionOfFile(this.file,j,this.mediaViewer);this.dialog._kill();h.trigger("analyticsEvent",{name:"confluence-spaces.previews.companion.version.update.request",data:{fileMimeType:this.file.attributes.originalContentType}})}.bind(this)});this.dialog.render();f.getDownloadURLFromFile(this.file,function(m){h.trigger("analyticsEvent",{name:"confluence-spaces.previews.companion.openWith.open.request",data:{fileMimeType:this.file.attributes.originalContentType}});var l=c.launchFileInApp(this.transaction,m,this.file.get("title"),this.app.id,"");l.on("file-uploaded",function(n){j=n});this.dialog.listenToFile(l)}.bind(this))},_startPolling:function(n,j){this.showSpinner=this.showSpinner||j;if(e.stopPolling){e.stopPolling()}var p=e.startPolling;if(p){var l=n.get(0).querySelector("#companion-download-buttons");var q=n.get(0).querySelector("#companion-spinner");var o=n.get(0).querySelector("#companion-edit-now");var k=n.get(0).querySelector("#ready");var m=n.get(0).querySelector("#not-ready");if(this.showSpinner){l.style.display="none";q.style.display="block";o.style.display="none"}p();this._onMeta=function(){l.style.display="none";q.style.display="none";o.style.display="block";o.querySelector(".edit-now-button").innerHTML=AJS.format("Edit this file now in {0}",this.app.displayName);k.style.display="block";m.style.display="none";o.addEventListener("click",this.launchFile.bind(this))}}}});return e});
}catch(e){WRMCB(e)};