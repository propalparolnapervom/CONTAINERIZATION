WRMCB=function(e){var c=console;if(c&&c.log&&c.error){c.log('Error running batched script.');c.error(e);}}
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:confluence-previews-js', location = '/js/amd/mediaviewer-amd.js' */
(function(){define("MediaViewer",MediaViewerFactory);define("FileViewer",MediaViewerFactory);define("core/template-store-singleton",function(){var properties=/^[a-zA-Z0-9.]+$/;return{get:function(name){return properties.test(name)?eval("FileViewer.Templates."+name):null}}});function MediaViewerFactory(){AJS.I18n.keys["cp.footer.expand.minimode"]="Show all files";AJS.I18n.keys["cp.footer.close.minimode"]="Hide all files";AJS.I18n.keys["cp.thumbnail.description"]="View a larger version of {0}";AJS.I18n.keys["cp.expand.thumbnail.minimode"]="Show all files";AJS.I18n.keys["cp.close.thumbnail.minimode"]="Hide all files";AJS.I18n.keys["cp.go.to.prev"]="Go to the previous file";AJS.I18n.keys["cp.go.to.next"]="Go to the next file";AJS.I18n.keys["cp.go.to.prev.page"]="Previous page";AJS.I18n.keys["cp.go.to.next.page"]="Next page";AJS.I18n.keys["cp.close"]="Close";AJS.I18n.keys["cp.download.original"]="Download";AJS.I18n.keys["cp.fit.to.page"]="Fit to page";AJS.I18n.keys["cp.zoom.in"]="Zoom in";AJS.I18n.keys["cp.zoom.out"]="Zoom out";AJS.I18n.keys["cp.enter.presentation.mode"]="Start Presentation";AJS.I18n.keys["cp.exit.presentation.mode"]="Exit Presentation";AJS.I18n.keys["cp.image.load.fail.header"]="Image could not be loaded.";AJS.I18n.keys["cp.image.load.fail"]="Unable to load file from {0}.";AJS.I18n.keys["cp.show.more"]="More";AJS.I18n.keys["cp.edit.file"]="Edit file";AJS.I18n.keys["cp.print.file"]="Print";AJS.I18n.keys["cp.delete.file"]="Delete";AJS.I18n.keys["cp.arrow.left.disabled"]="You\'re viewing the least recent file";AJS.I18n.keys["cp.arrow.right.disabled"]="You\'re viewing the most recent file";AJS.I18n.keys["cp.password.protected"]="Enter the password to open this file:";AJS.I18n.keys["cp.password.needed"]="Please enter the password to view this file.";AJS.I18n.keys["cp.password.incorrect"]="Invalid password. Please try again.";AJS.I18n.keys["cp.password.input.placeholder"]="Password";AJS.I18n.keys["cp.password.button.ok"]="OK";AJS.I18n.keys["cp.password.fullscreen.title"]="This file is password protected.";AJS.I18n.keys["cp.password.fullscreen.message"]="Due to technical reasons you have to leave presentation mode to enter the password.";AJS.I18n.keys["cp.error.button.download"]="Download";AJS.I18n.keys["cp.error.button.browser"]="Open in browser";AJS.I18n.keys["cp.error.image.missing.header"]="Ouch! We can\'t load the image.";AJS.I18n.keys["cp.error.pdf.missing.header"]="Ouch! We can\'t load the PDF.";AJS.I18n.keys["cp.error.media.default.header"]="Ouch! We can\'t load the media file.";AJS.I18n.keys["cp.error.pdf.password.header"]="Ouch! We can\'t show password protected files yet.";AJS.I18n.keys["cp.error.pdf.password.message"]="Try downloading the file to view it.";AJS.I18n.keys["cp.error.pdf.invalid.header"]="Ouch! Looks like this document is broken.";AJS.I18n.keys["cp.error.pdf.invalid.message"]="Try downloading the file to view it.";AJS.I18n.keys["cp.error.pdf.default.header"]="Ouch! Something is wrong with this file.";AJS.I18n.keys["cp.error.pdf.default.message"]="Try downloading the file to view it.";AJS.I18n.keys["cp.error.default.header"]="The file cannot be displayed";AJS.I18n.keys["cp.error.file.not.found"]="The file does not exist";AJS.I18n.keys["cp.error.file.no.viewer"]="Cannot find a viewer for the given file";AJS.I18n.keys["cp.file.converting.message.header"]="Your preview is on its way!";AJS.I18n.keys["cp.file.converting.message.text"]="In a hurry? You can download the original right now";AJS.I18n.keys["cp.unknown.file.type.header"]="We can\'t preview this file.";AJS.I18n.keys["cp.unknown.file.type.download.to.view"]="You\'ll have to download the file to view it.";AJS.I18n.keys["cp.unknown.file.type.downloadbutton"]="Download";AJS.I18n.keys["cp.unsupported.browser.header"]="Internet Explorer 9 can\'t preview this file.";AJS.I18n.keys["cp.unsupported.browser.download.to.view"]="You\'ll have to download the file or use a different browser to view it.";AJS.I18n.keys["cp.3d.file.type.toggle.grid"]="Toggle Grid";AJS.I18n.keys["cp.3d.file.type.toggle.camera.type"]="Toggle Camera Type";AJS.I18n.keys["cp.3d.file.type.toggle.light.type"]="Toggle Scene Light";AJS.I18n.keys["cp.3d.file.type.toggle.axis"]="Toggle Axis";AJS.I18n.keys["cp.companion.newversion"]="Update new version";AJS.I18n.keys["cp.companion.downloading"]="Opening...";AJS.I18n.keys["cp.companion.waitforupload"]="Waiting for file changes from {0}";AJS.I18n.keys["cp.companion.uploading"]="Saving...";AJS.I18n.keys["cp.companion.uploaded.prefix"]="Saved";AJS.I18n.keys["cp.companion.uploading.progress"]="{0} of {1}";AJS.I18n.keys["cp.companion.uploading.progress.done"]="Complete";AJS.I18n.keys["cp.companion.buttontitle"]="Edit with";return window.MediaViewer}}());
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:confluence-previews-js', location = '/js/amd/confluence-amd.js' */
define("confluence/legacy",function(){return Confluence});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:confluence-previews-js', location = '/js/confluence/file-utils.js' */
define("cp/confluence/file-utils",["underscore"],function(b){function e(f){if(f.id&&f.ownerId){return f.ownerId+"-"+f.id}return f.src}function c(f){return b.uniq(f,e)}function d(j,i){var k=a(i,function(l){return b.findWhere(j,{id:l.id})});var h=k[0];var g=k[1];var f=b.map(j,function(l){var m=b.findWhere(h,{id:l.id});return b.extend({},l,m)});return c(f.concat(g))}function a(i,f){var h=function(k){return !k};var j=i.filter(f);var g=i.filter(b.compose(h,f));return[j,g]}return{matchId:e,deDupeFiles:c,mergeFiles:d,partition:a}});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:confluence-previews-js', location = '/js/confluence/async-module-backend.js' */
define("cp/confluence/async-module-backend",["jquery","ajs"],function(f,b){var a={"pdf-viewer":"wr!com.atlassian.confluence.plugins.confluence-previews:confluence-previews-pdf"};var d="com.atlassian.confluence.plugins.confluence-previews:confluence-previews-pdf-worker";var c=function(h){var g=b.Meta.get("static-resource-url-prefix");return g+"/download/resources/"+d+"/"+h};function e(){var g=new f.Deferred();f.ajax({url:b.contextPath()+"/rest/webResources/1.0/resources",type:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify({r:[d],c:[],xc:[],xr:[]})}).done(function(l){var h;for(var k in l.resources){var j=l.resources[k].url;if(j&&j.indexOf(d)!==-1){h=j;break}}if(h){var m=c("bcmaps/");g.resolve({workerSrc:h,cMapUrl:m})}else{g.reject()}}).fail(g.reject.bind(g));return g.promise()}return function(g){if(a[g]){return WRM.require(a[g])}else{if(g==="pdf-config"){return e()}}}});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:confluence-previews-js', location = '/js/confluence/conversion-poller-backend.js' */
define("cp/confluence/conversion-poller-backend",["jquery","underscore","ajs"],function(d,c,b){function a(e){this._type=e;if(this._type==="thumbnail"){this._bulkUrl=b.contextPath()+"/rest/documentConversion/0.1/conversion/thumbnail/results";this._singleUrlBase=b.contextPath()+"/rest/documentConversion/0.1/conversion/thumbnail/"}else{this._bulkUrl=b.contextPath()+"/rest/documentConversion/0.1/conversion/convert/results";this._singleUrlBase=b.contextPath()+"/rest/documentConversion/0.1/conversion/convert/"}this._pollers={};this._timerId=0;this._interval=a.INITIAL_INTERVAL;this._debouncedChange=c.debounce(this._change,100)}a.INITIAL_INTERVAL=1000;a.MAX_INTERVAL=10000;a.BACKOFF_PERCENT=1.5;a.prototype.add=function(g,f){if(g&&!this._pollers[g]){var e=d.Deferred();this._pollers[g]={_dfd:e,_version:f};this._debouncedChange()}return this._pollers[g]._dfd.promise()};a.prototype.remove=function(e){var f=this._pollers[e];if(f){f._dfd.reject("cancelled");delete this._pollers[e]}};a.prototype._doPoll=function(){if(this._pollType==="single"){this._pollSingle()}else{if(this._pollType==="multiple"){this._pollMultiple()}}};a.prototype._backoff=function(){var e=this._interval*a.BACKOFF_PERCENT;this._interval=e>a.MAX_INTERVAL?a.MAX_INTERVAL:e;this._timerId=setTimeout(this._change.bind(this),this._interval)};a.prototype._change=function(){var f=this._getAttachmentIds();var e=!(f.length===0);this._cancel();if(!e){delete this._pollType;this._interval=1000}else{this._changeType();this._doPoll()}};a.prototype._changeType=function(){var g=this._getAttachmentIds();var f=g.length===1;var e=g.length>1;if(f&&this._pollType!=="single"){this._pollType="single"}else{if(e&&this._pollType!=="multiple"){this._pollType="multiple"}}};a.prototype._cancel=function(){clearTimeout(this._timerId);this._xhr&&this._xhr.abort();delete this._xhr};a.prototype._getAttachmentIds=function(){return Object.keys(this._pollers)};a.prototype._getIdsAndVersions=function(){var e=this._pollers;return c.map(this._getAttachmentIds(),function(f){return{id:f,v:e[f]._version}})};a.prototype._pollSingle=function(){var f=this._getAttachmentIds()[0];var g=this._pollers[f];var e=g._version;this._xhr=this._getSingle(f,e).always(function(){delete this._xhr}.bind(this)).done(function(i,j,h){if(h.status===202){this._backoff();g._dfd.notify("converting")}else{g._dfd.resolve(this._singleUrlBase+f+"/"+e,h.getResponseHeader("Content-Type"));delete this._pollers[f];this._change()}}.bind(this)).fail(function(h,j,i){if(h.status==429){this._backoff();g._dfd.notify("busy");return}if(i==="abort"){return}g._dfd.reject();delete this._pollers[f];this._change()}.bind(this))};a.prototype._getSingle=function(f,e){return d.ajax(this._singleUrlBase+f+"/"+e,{type:"HEAD",dataType:"json"})};a.prototype._pollMultiple=function(){this._xhr=d.ajax(this._bulkUrl,{type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(this._getIdsAndVersions())}).always(function(){delete this._xhr}.bind(this)).done(function(e){c(e).each(function(g,h){var i=this._pollers[h];if(!i){return}if(g==200){var f=i._version;if(this._type!=="thumbnail"){this._getSingle(h,f).done(function(k,l,j){i._dfd.resolve(this._singleUrlBase+h+"/"+f,j.getResponseHeader("Content-Type"));delete this._pollers[h]}.bind(this))}else{i._dfd.resolve(this._singleUrlBase+h+"/"+f,"image/jpg");delete this._pollers[h]}}else{if(g>=400&&g!=429){i._dfd.reject();delete this._pollers[h]}}}.bind(this));this._backoff()}.bind(this))};return a});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:confluence-previews-js', location = '/js/confluence/conversion-poller.js' */
define("cp/confluence/conversion-poller",["cp/confluence/conversion-poller-backend","jquery"],function(a,e){var b={};var c={};function d(k,g,i,f){if(!b[i]){b[i]=new a(i)}this.backend=b[i];this._attachmentId=k;this._version=g;var h=JSON.stringify({a:k,v:g,t:i});var j=c[h];if(j){this._promise=j.success?e.when(j.url,j.type):e.Deferred().reject(j.reason)}else{this._promise=this.backend.add(this._attachmentId,this._version);this._promise.then(function(l,m){c[h]={success:true,url:l,type:m}},function(l){if(l!=="cancelled"){c[h]={success:false,reason:l}}},f)}}d.prototype.stop=function(){this.backend.remove(this._attachmentId)};d.prototype.promise=function(){return this._promise};return d});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:confluence-previews-js', location = '/js/service/service-helpers.js' */
define("cp/service/service-helpers",["ajs","confluence/api/browser","confluence/api/url","jquery"],function(i,k,a,d){var h=["application/pdf","application/x-pdf"];var c=["image/jpeg","image/jpg","image/gif","image/png","image/bmp"];var j=[window.location.protocol,window.location.host].join("//");var b=j+i.contextPath();var f={};var g=function(r){if(r.id===-1){return{}}var z=r.contentType;var y=r.previewContents.THUMBNAIL;var A=r.previewContents.POSTER;var p=r.previewContents.DOCUMENT;var q=r.previewContents.DOCUMENT_HD;var s=r.previewContents.POSTER_HD;var m=i.DarkFeatures.isEnabled("preview.full.image");var n=function(C){return i.DarkFeatures.isEnabled("document.conversion.direct.download")?C:b+C};var o=null;var w=null;var v=null;var B=null;var l=null;if(y){o=n(y.downloadUrl)}if(A){B=n(A.downloadUrl)}var x=m?h.concat(c):h;if(p&&x.indexOf(z)<0){w=n(p.downloadUrl);z="application/octet-stream"}else{w=b+r.downloadUrl;var t=new k(window.navigator.userAgent);if(z==="application/pdf"&&t.isIE()&&t.version()<=11){var u=a.parse(w);u.queryParams.stream=[true];w=a.format(u)}}if(q){v=n(q.downloadUrl)}if(s){l=n(s.downloadUrl)}return{src:w,src_hd:v,srcDownload:b+r.downloadUrl+"&download=true",type:z,originalContentType:r.contentType,thumbnail:o,poster:B,poster_hd:l,title:r.fileName,name:r.fileName,id:r.id.toString(),ownerId:r.containerId&&r.containerId.toString(),version:r.version,hasReplyPermission:r.hasReplyPermission,hasUploadAttachmentVersionPermission:r.hasUploadAttachmentVersionPermission}};var e=function(m){var l=d.Deferred();if(!f[m]){d.ajax({url:i.contextPath()+"/rest/api/space/"+m,type:"GET",dataType:"json",contentType:"application/json; charset=utf-8"}).then(function(n){f[m]=n.id.toString();l.resolve(f[m])}).fail(function(n,p,o){l.reject(n,p,o)})}else{l.resolve(f[m])}return l.promise()};return{responseToFile:g,getSpaceId:e}});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:confluence-previews-js', location = '/js/service/comments-service.js' */
define("cp/service/comments-service",["underscore","ajs","jquery","cp/service/service-helpers"],function(h,f,d,a){function c(j,k){this.url=f.contextPath()+"/rest/files/1.0/files/"+j+"/comments";this.version=k}var e=function(j,k){return function(l){return f.defaultIfUndefined(l,{rootObject:j,defaultValue:k})}};var b=function(j){var l=e(j,"");var m=e(j,undefined);var k=m("history.createdDate")||new Date();return{id:l("id"),author:{name:l("history.createdBy.displayName"),avatar:l("history.createdBy.profilePicture.path"),profile:f.contextPath()+"/display/~"+l("history.createdBy.username")},comment:l("body.view.value"),editorFormat:l("body.editor.value"),date:k,hasDeletePermission:j.hasDeletePermission,hasEditPermission:j.hasEditPermission,hasReplyPermission:j.hasReplyPermission,hasResolvePermission:j.hasResolvePermission}};var g=function(j){var l=e(j,undefined);var k=e(j,false);return h.extend({pageNumber:l("anchor.page"),position:[l("anchor.x"),l("anchor.y")],resolved:k("resolved.value")},b(j))};var i=function(m,k){var l=m.changedAttributes();if(l.hasOwnProperty("resolved")&&k){return{resolved:m.get("resolved")}}var j={parentId:m.get("parentId"),commentBody:m.get("editorFormat")};if(m.get("position")||m.get("pageNumber")){j=h.extend({},j,{anchor:{x:m.get("position")[0],y:m.get("position")[1],page:m.get("pageNumber"),type:"pin"}})}return j};c.prototype._makeUrl=function(j){if(!j){j=""}return this.url+j+(this.version?("?attachmentVersion="+this.version):"")};c.prototype.getAnnotations=function(l){var j=d.Deferred();var k=h.extend({},l);d.ajax({url:this._makeUrl(),type:"GET",data:{limit:k.limit,start:k.start},dataType:"json"}).then(function(m){var n=h.map(m.results,g);j.resolve(n)}).fail(function(m,o,n){j.reject(m,o,n)});return j.promise()};c.prototype.getReplies=function(l){var j=d.Deferred();var k=h.extend({},l);d.ajax({url:this._makeUrl("/"+l.parentId),type:"GET",data:{limit:k.limit,start:k.start},dataType:"json"}).then(function(o){var p=e(o,[]);var m=p("children");var n=h.map(m,b);j.resolve(n)}).fail(function(m,o,n){j.reject(m,o,n)});return j.promise()};c.prototype.save=function(m){var j=d.Deferred();var l=m.get("id")?"PUT":"POST";var k=(l==="PUT")?this._makeUrl("/"+m.get("id")):this._makeUrl();d.ajax({url:k,type:l,data:JSON.stringify(i(m,(l==="PUT"))),dataType:"json",contentType:"application/json; charset=utf-8"}).then(function(n){j.resolve(b(n))}).fail(function(n,p,o){j.reject(n,p,o)});return j.promise()};c.prototype.sendTrackEvent=function(j){var l=j.attributes&&j.attributes.resolved;var k=f.Meta.get("space-key");var m=a.getSpaceId(k);m.done(function(q){if(!l){try{var p={type:"ATLASSIAN_CONFLUENCE_ANALYTICS_NEXT_TRACK",payload:{containerType:"space",containerId:q,source:"previewFileScreen",objectType:"page",objectId:f.Meta.get("content-id"),action:j.previous("comment")?"updated":"created",actionSubject:"comment",actionSubjectId:j.get("id"),attributes:{commentType:"file",pageType:f.Meta.get("draft-type"),parentCommentId:j.previous("parentId")}}};var n=require("confluence/legacy-message-queue");n.push(p)}catch(o){}}})};c.prototype.remove=function(k){var j=d.Deferred();d.ajax({url:this._makeUrl("/"+k.get("id")),type:"DELETE",dataType:"json"}).then(function(){j.resolve()}).fail(function(l,n,m){j.reject(l,n,m)});return j.promise()};return c});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:confluence-previews-js', location = '/js/service/versions-service.js' */
define("cp/service/versions-service",["ajs","jquery","underscore","cp/service/service-helpers"],function(a,f,c,g){var b=a.contextPath();var e=function(j,h,i){return f.ajax({url:b+"/rest/files/1.0/files/content/"+j+"/byAttachmentId",type:"GET",dataType:"json",contentType:"application/json; charset=utf-8",data:{attachmentId:h,attachmentVersion:i}}).pipe(function(k){return g.responseToFile(k)})};function d(){}d.prototype.getAllFileVersions=function(h){var i=b+"/rest/files/1.0/files/"+h+"/versions";return f.ajax(i).pipe(function(k){var j=k.results;return c.sortBy(c.map(j,function(l){return{id:l.id,version:l.version.number,message:l.version.message,countComments:l.countComments,ownerId:l.ownerId}}),function(l){return 0-l.version})})};d.prototype.getFileVersion=function(j,h,i){return e(j,h,i)};return d});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:confluence-previews-js', location = '/js/service/files-service.js' */
define("cp/service/files-service",["ajs","jquery","underscore","cp/service/service-helpers"],function(a,e,c,f){var b=a.contextPath();function d(g){this.url=b+"/rest/files/1.0/files/content/"+g}d.prototype.getFiles=function(i){var g=e.Deferred();var h=c.extend({},i);e.ajax({url:this.url,type:"GET",data:{"max-results":h.limit,"start-index":h.start},dataType:"json"}).then(function(k){var j=c.map(k.results,f.responseToFile);g.resolve(j)}).fail(function(j,l,k){g.reject(j,l,k)});return g.promise()};d.prototype.getFilesWithId=function(h){var g=e.Deferred();e.ajax({url:this.url+"/byAttachmentIds",type:"POST",data:JSON.stringify({attachmentIds:h}),dataType:"json",contentType:"application/json; charset=utf-8"}).then(function(j){var i=c.map(j.results,f.responseToFile);g.resolve(i)}).fail(function(i,k,j){g.reject(i,k,j)});return g.promise()};d.prototype.getFileWithId=function(g){return this.getFilesWithId([g]).pipe(function(h){return h[0]})};d.prototype.getFilesWithoutId=function(h){var g=e.Deferred();e.ajax({url:this.url+"/minusAttachmentIds",type:"POST",data:JSON.stringify({attachmentIds:h}),dataType:"json",contentType:"application/json; charset=utf-8"}).then(function(j){var i=c.map(j.results,f.responseToFile);g.resolve(i)}).fail(function(i,k,j){g.reject(i,k,j)});return g.promise()};return d});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:confluence-previews-js', location = '/js/confluence/file-preview-loader.js' */
define("cp/confluence/file-preview-loader",["jquery","underscore","ajs","cp/confluence/preview-support","cp/confluence/async-module-backend","MediaViewer","cp/confluence/conversion-poller","cp/service/files-service","cp/service/comments-service","cp/service/versions-service","cp/confluence/file-utils","confluence/api/logger","confluence/jsUri"],function(D,Y,p,W,X,i,x,d,s,U,N,v,P){var K,C={},l,e=false,F=!!p.DarkFeatures.isEnabled("improving.performance.loading.image.previews");var c=window.decodeURIComponent;var H=function(aa,ab){p.trigger("analyticsEvent",{name:aa,data:ab});if(aa==="files.fileviewer-web.file.download"){ab.isProject=!!(p.Meta.get("space-type")==="project"&&D('[data-internal-id="tab-files"]').length);p.trigger("analyticsEvent",{name:"confluence-spaces.previews.download",data:ab})}};var E=i.require("file-types/file-types");function S(aa){return aa.attr("data-image-src")||aa.attr("data-file-src")||aa.attr("src")||aa.attr("href")}function L(aa){return aa.attr("data-linked-resource-content-type")||aa.attr("data-mime-type")||"image/web"}function A(ab){var aa=D(ab);var ac=S(aa);var ad=aa.attr("data-linked-resource-default-alias");return{src:ac,srcDownload:ac+"&download=true",thumbnail:ac,type:L(aa),title:ad||ac,name:ad,id:aa.attr("data-linked-resource-id"),version:aa.attr("data-linked-resource-version"),ownerId:aa.attr("data-linked-resource-container-id"),isRemoteLink:aa.hasClass("confluence-external-resource"),shouldEdit:aa.attr("data-should-edit")==="true",referer:aa.attr("data-file-referer")}}function G(aa){return Y.map(aa,function(ab){return A(ab)})}function Z(aa){if(i.isPluginEnabled("annotation")){if(W.isFallbackModeIframe){W.autoShowAnnotationsOnParent();return}aa.once("fv.showFile",function(){i.getPlugin("annotation").showAnnotationsPanel(aa)})}}function O(ab){var ac=null;if(ab){var aa=D(ab);ac={id:aa.attr("data-linked-resource-id"),ownerId:aa.attr("data-linked-resource-container-id")}}else{var ad=(new P(window.location.href)).getQueryParamValue("preview");if(ad){ad=c(ad).split("/");ac={ownerId:ad[1],id:ad[2]}}}return ac}function Q(aa,ab){return aa.id===ab.id&&aa.ownerId===ab.ownerId}function g(aa,ab){return !!Y.find(ab,function(ac){return Q(ac,aa)})}function y(aa){J(false);K.__willReopen=true;K.close();K.open(aa);delete K.__willReopen;J(true)}function o(){if(i.isPluginEnabled("permalink")){i.getPlugin("permalink").setRoutingEnabled(true);i.getPlugin("permalink").startRouting()}}function J(aa){if(i.isPluginEnabled("permalink")){i.getPlugin("permalink").setRoutingEnabled(aa)}}function I(aa,ac,ab,ae){var ad;if(K&&aa&&e&&l===ab){z(aa,ab,true);ad=D.when()}else{K&&K.isOpen()&&K.close();ad=V(ab);e=true}ad.then(function(){if(!ac){return}var ag=D(ac);var aj=ag.attr("data-linked-resource-id"),af=ag.attr("data-linked-resource-container-id"),ai=ag.attr("data-image-src")||ag.attr("data-file-src")||ag.attr("src");var ah=(aj&&af)?{id:aj,ownerId:af}:{src:ai};K.open(ah,"main");if(ae){Z(K)}})}var w={showPreviewerForComment:function(ae,af,ad,ah){var aa=D(ae);var ag=af.find(W.getFileSelectorString());var ac=Y.uniq(ag,function(ai){return ai.src||ai.href});var ab=G(ac);w.setupPreviewerForComment(ab,ad,false).then(function(){var al=aa.attr("data-linked-resource-id"),ai=aa.attr("data-linked-resource-container-id"),ak=aa.attr("data-image-src")||aa.attr("data-file-src")||aa.attr("src");var aj=(al&&ai)?{id:al,ownerId:ai}:{src:ak};K.open(aj,"comments");if(ah){Z(K)}})},setupPreviewerForComment:function(aa,ab,ad){r(aa,ab);var ac=t(aa,false);z(aa,ab,ad);ac.then(function(ae){K.updateFiles(ae,N.matchId)});return ac}};function t(ab,ad){var ac=D.when();var aa=p.Meta.get("page-id");if(aa){ac=M(ab||[],aa,ad)}return ac}function a(ac,ab,ag){var ae=D(ac),ah=ae.data("linked-resource-container-id"),af=ae.data("linked-resource-id"),aa=new d(ah),ad=A(ac);aa.getFileWithId(af).then(function(ai){j();T([Y.extend({},ad,ai)],ab,ag)},function(ai){v.log("Error loading previewer for attachment with Id "+af+ai)})}function T(ad,ac,ag){var ab=u(ad,ac);var af=ab.getFiles();if(af.length){if(af.length>1){var aa=O(ad);af=Y.filter(af,function(ah){return ah.id===aa.id&&ah.ownerId===aa.ownerId});ab.updateFiles(af,N.matchId)}ab.open({id:af[0].id,ownerId:af[0].ownerId},ag)}else{var ae=t([],true);ae.then(function(ai){ab.updateFiles(ai,N.matchId);var al=ab.getFiles();var ah=O();var ak=!ah?[]:al.filter(function(am){return am.id===ah.id});var aj={id:ak.length?ak[0].id:al[0].id};ab.open(aj,ag);o()})}}function u(ab,aa){var ac=Y.isArray(ab)?ab:G(D(ab));z(ac,aa,false);return K}var n;var h=function(ab){var ad=D.Deferred();var ac={};var aa={src_hd:null,poster_hd:null};if(ab.get("src_hd")){D.ajax({type:"HEAD",async:true,url:ab.get("src_hd")}).then(function(ae,ag,af){ad.resolve(af.status!==200?aa:ac)},function(ae,ag,af){ad.resolve(aa)})}else{ad.resolve(ac)}return ad.promise()};var B=function(ac){n&&n.stop();var ad=ac.get("id");var ab=ac.get("version");var aa=D.Deferred();if(!ad){return D.when(true,ac.get("src"),ac.get("type"))}n=new x(ad,ab,"conversion",function(ae){if(ae==="converting"||ae==="busy"){aa.resolve(false,ac.get("src"),ac.get("type"))}});n.promise().then(function(af,ae){if(aa.state()!=="pending"){return}h(ac).done(function(ag){aa.resolve(true,ac.get("src"),ae,ag)}).fail(function(){aa.resolve(true,ac.get("src"),ae)})}).fail(function(ae){if(aa.state()!=="pending"){return}if(ae==="cancelled"){aa.reject(ae)}else{h(ac).done(function(af){aa.resolve(true,ac.get("src"),ac.get("type"),af)}).fail(function(){aa.resolve(true,ac.get("src"),ac.get("type"))})}});return aa.promise()};var b=function(ac){n&&n.stop();var ad=ac.get("id");var ab=ac.get("version");var aa=D.Deferred();if(!ad){return D.when(true,ac.get("src"),ac.get("type"))}var ae=ac.get("originalContentType");if(ae&&/^image\//i.test(ae)){aa.resolve(true,ac.get("src"),ae)}else{n=new x(ad,ab,"conversion",function(af){if(af==="converting"||af==="busy"){aa.resolve(false,ac.get("src"),ac.get("type"))}});n.promise().then(function(ag,af){if(aa.state()!=="pending"){return}h(ac).done(function(ah){aa.resolve(true,ac.get("src"),af,ah)}).fail(function(){aa.resolve(true,ac.get("src"),af)})}).fail(function(af){if(aa.state()!=="pending"){return}if(af==="cancelled"){aa.reject(af)}else{h(ac).done(function(ag){aa.resolve(true,ac.get("src"),ac.get("type"),ag)}).fail(function(){aa.resolve(true,ac.get("src"),ac.get("type"))})}})}return aa.promise()};var R=function(ac){n&&n.stop();var ad=ac.get("id");var ab=ac.get("version");var aa=D.Deferred();n=new x(ad,ab,"conversion");n.promise().done(function(af,ae){aa.resolve(ac.get("src"),ae)}).fail(function(ae){if(ae!=="cancelled"){aa.resolve(ac.get("src"),ac.get("type"))}else{aa.reject(ae)}});return aa.promise()};var k=function(ad){var ag=ad.get("type"),ab=ad.get("src"),ac=ad.get("id"),ah=ad.get("isRemoteLink"),aj=D.Deferred();var af=p.DarkFeatures.isEnabled("previews.dcl-image-thumbnails");if((!af&&!ah&&E.isImageBrowserSupported(ag))){var aa=ab.replace("/attachments/","/thumbnails/");aj.resolve(aa,"image/jpeg")}else{if(ac){var ae=ad.get("version");var ai=new x(ac,ae,"thumbnail");ai.promise().done(function(al,ak){aj.resolve(al,ak)}).fail(function(){aj.reject()})}else{aj.resolve(ab,ag)}}return aj.promise()};function r(ad,ab){l=ab;if(C[l]){K=C[l];return K}var ac=p.Meta.get("static-resource-url-prefix");var aa="com.atlassian.confluence.plugins.confluence-previews:mediaviewer-chunks";var ae=ac+"/download/resources/"+aa+"/";var ag={appendTo:D("body"),files:ad,filesService:d,commentService:s,versionsService:U,enableAnnotations:p.DarkFeatures.isEnabled("file-annotations"),enablePermalinks:p.DarkFeatures.isEnabled("previews.sharing")&&ab==="full"&&!W.isFallbackModeIframe,enableMiniMode:true,enableShareButton:true,enableVersionNavigation:true,viewers:["image","document","video"],analyticsBackend:H,assets:{basePath:ae},i18n:p.I18n.keys,fetchToken:m};if(ab===W.VIEW_MODE.SIMPLE){ag.enableAnnotations=false;ag.enableMiniMode=false;ag.enableShareButton=false;ag.enableVersionNavigation=false}if(p.DarkFeatures.isEnabled("previews.conversion-service")){ag.isPreviewGenerated=F?b:B;ag.generatePreview=R;ag.generateThumbnail=k}if(W.isFallbackModeIframe){i.prototype.open=function(ah,ai){this._isOpen=true;W.sendPreviewerToParent(this.getFiles(),ab,ah,ai)}}K=new i(ag);C[l]=K;K.on("fv.showFile",function(){var ah=require("confluence/api/event");ah.trigger("confluence-previews.fileviewer.completed")});var af=K.getView();af.show=Y.compose(af.show,function(ah){p.trigger("remove-bindings.keyboardshortcuts");return ah});af.hide=Y.compose(af.hide,function(ah){p.trigger("add-bindings.keyboardshortcuts");return ah});return K}function f(ac,ab){var aa=r(ac,ab);o();return aa}function q(ag,ad,af,ak){af=af||"full";var aj=O();var ai=ag||aj;var ac=function(al,am){if(al){o();K.open(ai)}else{if(am){y(am)}}};if(!ag&&!aj){K&&K.close();return K}r(ad,af);if(ad&&ad.length){K.updateFiles(ad,N.matchId)}var ae=K.getCurrent();var ah=ae&&ae.id===ai.id&&ae.ownerId===ai.ownerId;var ab=g(ag||aj,K.getFiles());if(ah){return}if(!ab){var aa=!p.Meta.get("question-id");t(null,aa).then(function(al){if(!al||!al.length){return}K.updateFiles(al,N.matchId);ac(ag,aj)})}else{ac(ag,aj)}if(ak){Z(K)}o();return K}function z(ac,aa,ab){if(!K||l!==aa){K&&K.close();r(ac,aa)}K.updateFiles(N.deDupeFiles(ac),N.matchId);J(ab)}function V(ad){var ac=Y.uniq(D(W.getFileSelectorString()),function(ag){return D(ag).attr("data-linked-resource-id")||ag.src});var ab=G(ac);var af=p.Meta.get("user-timezone-offset");if(!af){p.Meta.set("user-timezone-offset",0)}var ae;var aa=p.Meta.get("page-id");if(aa){ae=M(ab,aa,true)}else{ae=D.when()}return ae.then(function(ag){z(ag,ad,true);if(i.isPluginEnabled("permalink")){i.getPlugin("permalink").startRouting()}})}function m(aa){return D.when(aa.attributes)}function M(ac,ab,ag){var ae=Y.filter(ac,function(ai){return !!ai.id}),af=Y.pluck(ae,"id"),ah=ab,aa=new d(ah);var ad=[];if(af.length){ad.push(aa.getFilesWithId(af));if(!F&&ag){ad.push(aa.getFilesWithoutId(af))}}else{ad.push(aa.getFiles())}return D.when.apply(D,ad).pipe(function(){var ak=Y.reduce(arguments,function(an,am){return an.concat(am)});var al=p.DarkFeatures.isEnabled("previews.trigger-all-file-types");var aj=p.DarkFeatures.isEnabled("previews.conversion-service");var ai=ak;if(!al&&!aj){ai=Y.filter(ak,function(am){return E.isImage(am.type)||(E.isPDF(am.type)&&W.isPDFSupported())})}return N.mergeFiles(ac,ai)})}function j(){if(K){console.info("File Preview: reset files list");K._files.reset()}}return{showPreviewer:I,showPreviewerForSingleFile:T,setupPreviewForSingleFile:u,showPreviewerForComment:w.showPreviewerForComment,setupPreviewerForFallbackMode:f,setupPreviewerForSPA:q,autoShowAnnotationsPanel:Z,resetPreviewFileList:j,fetchAndShowPreviewerForSingleFile:a}});
}catch(e){WRMCB(e)};