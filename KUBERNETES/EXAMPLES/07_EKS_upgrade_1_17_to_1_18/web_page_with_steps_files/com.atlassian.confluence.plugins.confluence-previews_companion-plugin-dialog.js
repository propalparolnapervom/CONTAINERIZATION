WRMCB=function(e){var c=console;if(c&&c.log&&c.error){c.log('Error running batched script.');c.error(e);}}
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:companion-plugin-dialog', location = 'js/component/companion/companion-dialog.js' */
define("cp/component/companion/dialog",["jquery","backbone","core/template-store-singleton","moment","confluence/api/event","ADCClient",],function(f,h,b,g,a,e){function d(j){var l=["Bytes","KB","MB","GB","TB"];if(j===0){return"0 Byte"}var k=parseInt(Math.floor(Math.log(j)/Math.log(1024)));return Math.round(j/Math.pow(1024,k),2)+" "+l[k]}var c=h.View.extend({id:"companion-dialog",tagName:"section",className:"aui-layer aui-dialog2 aui-dialog2-small",events:{"click .cancel-button":"_cancel"},initialize:function(i){this._mediaViewer=i.mediaViewer;this._file=i.file;this._confirmSave=i.confirmSave;this._app=i.app;this._transaction=i.transaction;this.$el.attr({role:"dialog","aria-hidden":"true","data-aui-remove-on-hide":"true","data-aui-modal":"true","data-fv-allow-focus":"true"})},render:function(){this.$el.html(b.get("companionDialog")());this._updateElements();this.bodyInlineCSSOverflowValue=f("body")[0].style.overflow;this.dialog=AJS.dialog2(this.$el).show();window.addEventListener("beforeunload",this._beforeUnload);this._mediaViewer.getView().lockNavigationKeys();this.$updateButton.on("click",this._confirmSave);return this},listenToFile:function(i){this.localFile=i;i.on("file-download-start",this._startDownload.bind(this));i.on("file-download-progress",this._updateProgress.bind(this));i.on("file-downloaded",this._waitForUpload.bind(this));i.on("file-upload-start",this._startUpload.bind(this));i.on("file-upload-progress",this._updateProgress.bind(this));i.on("file-uploaded",this._waitForSave.bind(this));i.on("file-deleted",this._kill.bind(this));if(window.Notification){if(Notification.permission!=="granted"){Notification.requestPermission().then(function(){this._showNotification(i)}.bind(this))}else{this._showNotification(i)}}},_beforeUnload:function(i){i.returnValue="We are still waiting for file changes, are you sure you want to quit?"},_showNotification:function(i){if(!window.Notification||Notification.permission!=="granted"){return}i.on("file-uploaded",function(){if(this._notification){this._notification.close()}this._notification=new Notification(AJS.format("New Version of {0} Uploaded",this._file.get("title")),{body:"A new version of your file has been uploaded to Confluence",});this._notification.onclick=function(){window.focus();this._notification.close()}.bind(this);this._notification.onclose=function(){this._notification=null}.bind(this)}.bind(this))},_updateProgress:function(i){if(i===null){AJS.progressBars&&AJS.progressBars.setIndeterminate(this.$progressBar)}else{AJS.progressBars&&AJS.progressBars.update(this.$progressBar,i.percentage/100);this.$progressString.text(AJS.format("{0} of {1}",d(parseInt(i.transferred,10)),d(parseInt(i.length,10))))}},_startDownload:function(){this.$currentAction.text("Opening...");this.__downloadStart=Date.now()},_startUpload:function(){this.$currentAction.text("Saving...");this.$progressString.text("Complete");this._updateProgress(null);this.$updateButton.attr("disabled",true);a.trigger("analyticsEvent",{name:"confluence-spaces.previews.companion.save.request",data:{fileMimeType:this._file.attributes.originalContentType}})},_waitForUpload:function(){this.$currentAction.text(AJS.format("Waiting for file changes from {0}",this._app.displayName));this.$progressString.text("Complete");this._updateProgress(null);a.trigger("analyticsEvent",{name:"confluence-spaces.previews.companion.openWith.download.success",data:{fileMimeType:this._file.attributes.originalContentType,timeFromStart:Date.now()-this.__downloadStart}});delete this.__downloadStart},_waitForSave:function(){var i=g().format("MMM DD YYYY HH:mma");this.$currentAction.text("Saved"+": "+i);this.$updateButton.attr("disabled",false);a.trigger("analyticsEvent",{name:"confluence-spaces.previews.companion.save.success",data:{fileMimeType:this._file.attributes.originalContentType}});this.__uploadDone=Date.now()},_updateElements:function(){this.$header=this.$(".aui-dialog2-header-main");this.$progressBar=this.$(".aui-progress-indicator");this.$cancelButton=this.$(".cancel-button");this.$updateButton=this.$(".close-button");this.$currentAction=this.$(".companion-action-text");this.$progressString=this.$(".companion-progress-text")},_cancel:function(){var i;var j;if(this.__downloadStart){i="openWith";j=this.__downloadStart}else{if(this.__uploadDone){i="openWith.save";j=this.__uploadDone}}if(this.localFile){e.cancelFileLaunch(this._transaction,this.localFile)}a.trigger("analyticsEvent",{name:"confluence-spaces.previews.companion."+i+".cancel",data:{fileMimeType:this._file.attributes.originalContentType,timeFromStart:Date.now()-j}});this._kill()},_kill:function(){window.removeEventListener("beforeunload",this._beforeUnload);this.dialog.hide();f("body")[0].style.overflow=this.bodyInlineCSSOverflowValue;this._mediaViewer.getView().unlockNavigationKeys()}});return c});
}catch(e){WRMCB(e)};