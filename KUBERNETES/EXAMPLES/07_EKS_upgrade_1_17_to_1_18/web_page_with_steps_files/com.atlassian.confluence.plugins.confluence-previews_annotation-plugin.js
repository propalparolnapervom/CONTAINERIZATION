WRMCB=function(e){var c=console;if(c&&c.log&&c.error){c.log('Error running batched script.');c.error(e);}}
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/templates/annotation.soy' */
// This file was automatically generated from annotation.soy.
// Please don't edit this file by hand.

/**
 * @fileoverview Templates in namespace FileViewer.Templates.Annotation.
 */

if (typeof FileViewer == 'undefined') { var FileViewer = {}; }
if (typeof FileViewer.Templates == 'undefined') { FileViewer.Templates = {}; }
if (typeof FileViewer.Templates.Annotation == 'undefined') { FileViewer.Templates.Annotation = {}; }


FileViewer.Templates.Annotation.controlAnnotationButton = function(opt_data, opt_ignored) {
  return '<a href="#" id="cp-control-panel-annotations" class="cp-icon" title="' + soy.$$escapeHtml('Comments') + '">' + soy.$$escapeHtml('Comments') + '.<div class="counter">0</div></a>';
};
if (goog.DEBUG) {
  FileViewer.Templates.Annotation.controlAnnotationButton.soyTemplateName = 'FileViewer.Templates.Annotation.controlAnnotationButton';
}


FileViewer.Templates.Annotation.blankAnnotation = function(opt_data, opt_ignored) {
  return '<div id="cp-blank-annotation"><h5>' + soy.$$escapeHtml('Review and collaborate on this file') + '</h5><p>' + soy.$$escapeHtml('You can comment on most files (except audio and video), just drag a pin to where you want to add the first comment.') + '</p><p>' + soy.$$escapeHtml('@Mention team members in your comment to get their attention.') + '</p></div>';
};
if (goog.DEBUG) {
  FileViewer.Templates.Annotation.blankAnnotation.soyTemplateName = 'FileViewer.Templates.Annotation.blankAnnotation';
}


FileViewer.Templates.Annotation.annotationHeader = function(opt_data, opt_ignored) {
  return '<div class="cp-error"/><a id="cp-annotation-next" title="' + soy.$$escapeHtml('Next comment') + '" class="cp-small-icon" href="#">' + soy.$$escapeHtml('Next comment') + '</a><a id="cp-annotation-previous" title="' + soy.$$escapeHtml('Previous comment') + '" class="cp-small-icon" href="#">' + soy.$$escapeHtml('Previous comment') + '</a>' + ((opt_data.current != 0) ? '<span id="cp-annotation-count">' + soy.$$escapeHtml(AJS.format('{0} of {1}',opt_data.current,opt_data.total)) + '</span>' : '') + ((opt_data.canDelete && ! opt_data.resolved) ? '<a id="cp-annotation-more" href="#cp-annotations-more-menu" aria-owns="cp-annotations-more-menu" aria-haspopup="true" class="aui-dropdown2-trigger aui-dropdown2-trigger-arrowless" data-fv-allow-focus="true">' + aui.icons.icon({useIconFont: true, size: 'small', icon: 'more', accessibilityText: 'More', extraClasses: 'cp-small-icon up'}) + '</a><div id="cp-annotations-more-menu" class="aui-dropdown2 aui-style-default" data-fv-allow-focus="true"><ul class="aui-list-truncate"><li><a href="#" id="cp-annotation-delete">' + soy.$$escapeHtml('Delete') + '</a></li></ul></div>' : '');
};
if (goog.DEBUG) {
  FileViewer.Templates.Annotation.annotationHeader.soyTemplateName = 'FileViewer.Templates.Annotation.annotationHeader';
}


FileViewer.Templates.Annotation.annotationUserHeader = function(opt_data, opt_ignored) {
  return '<div class="' + soy.$$escapeHtml(opt_data.small == true ? 'cp-annotation-user-small' : 'cp-annotation-user') + '"><img src="' + soy.$$escapeHtml(opt_data.author.avatar) + '"></img><a href="' + soy.$$escapeHtml(opt_data.author.profile) + '">' + soy.$$escapeHtml(opt_data.author.name) + '</a></div>';
};
if (goog.DEBUG) {
  FileViewer.Templates.Annotation.annotationUserHeader.soyTemplateName = 'FileViewer.Templates.Annotation.annotationUserHeader';
}


FileViewer.Templates.Annotation.addAnnotation = function(opt_data, opt_ignored) {
  return '<div class="cp-error"/><div class="cp-annotation-adding">' + FileViewer.Templates.Annotation.annotationUserHeader(opt_data) + FileViewer.Templates.Annotation.annotationTextarea(null) + '</div>';
};
if (goog.DEBUG) {
  FileViewer.Templates.Annotation.addAnnotation.soyTemplateName = 'FileViewer.Templates.Annotation.addAnnotation';
}


FileViewer.Templates.Annotation.annotationTextarea = function(opt_data, opt_ignored) {
  return '<div class="cp-add-annotation cp-editor">' + FileViewer.Templates.Annotation.editorLoader(null) + '</div>';
};
if (goog.DEBUG) {
  FileViewer.Templates.Annotation.annotationTextarea.soyTemplateName = 'FileViewer.Templates.Annotation.annotationTextarea';
}


FileViewer.Templates.Annotation.topLevelAnnotation = function(opt_data, opt_ignored) {
  return '<div id="cp-top-level-annotation" data-commentId=' + soy.$$escapeHtml(opt_data.id) + '>' + FileViewer.Templates.Annotation.annotationUserHeader(opt_data) + '<div id="cp-annotation-main-comment" class="cp-annotation-comment  wiki-content"><p>' + soy.$$filterNoAutoescape(opt_data.comment) + '</p></div><ul class="cp-annotation-actions">' + ((opt_data.canEdit && ! opt_data.resolved) ? '<li><a class="cp-annotation-edit" href="#">' + soy.$$escapeHtml('Edit') + '</a></li>' : '') + ((opt_data.canResolve) ? '<li><a class="cp-annotation-resolve" href="#">' + ((opt_data.resolved) ? soy.$$escapeHtml('Unresolve') : soy.$$escapeHtml('Resolve')) + '</a></li>' : '') + ((! opt_data.resolved) ? '<span class="cp-annotation-comment-like"></span>' : '') + '<li class="nobullet">' + soy.$$escapeHtml(AJS.DateTimeFormatting.friendlyFormatDateTime(new Date(opt_data.date), new Date(), Number(AJS.Meta.get('user-timezone-offset')))) + '</li></ul></id>';
};
if (goog.DEBUG) {
  FileViewer.Templates.Annotation.topLevelAnnotation.soyTemplateName = 'FileViewer.Templates.Annotation.topLevelAnnotation';
}


FileViewer.Templates.Annotation.likes = function(opt_data, opt_ignored) {
  return '<li>' + ((opt_data.hasLiked) ? '<a class="cp-annotation-unlike" href="#">' + soy.$$escapeHtml('Unlike') + '</a>' : '<a class="cp-annotation-like" href="#">' + soy.$$escapeHtml('Like') + '</a>') + '</li>' + ((opt_data.likes > 0) ? '<li><span class="cp-annotation-like-summary"><span class="cp-annotation-like-icon aui-icon aui-icon-small aui-iconfont-like-small"></span><span class="cp-annotation-count">' + soy.$$escapeHtml(opt_data.likes) + '</span></span></li>' : '');
};
if (goog.DEBUG) {
  FileViewer.Templates.Annotation.likes.soyTemplateName = 'FileViewer.Templates.Annotation.likes';
}


FileViewer.Templates.Annotation.annotationReply = function(opt_data, opt_ignored) {
  return FileViewer.Templates.Annotation.annotationUserHeader({author: opt_data.author, small: true}) + '<div class="cp-annotation-comment wiki-content" data-commentId=' + soy.$$escapeHtml(opt_data.id) + '><p>' + soy.$$filterNoAutoescape(opt_data.comment) + '</p></div><ul class="cp-annotation-actions">' + ((! opt_data.resolved) ? ((opt_data.canEdit) ? '<li><a class="cp-annotation-edit" href="#">' + soy.$$escapeHtml('Edit') + '</a></li>' : '') + ((opt_data.canDelete) ? '<li><a class="cp-annotation-delete" href="#">' + soy.$$escapeHtml('Delete') + '</a></li>' : '') + '<span class="cp-annotation-reply-like"></span>' : '') + '<li class="nobullet">' + soy.$$escapeHtml(AJS.DateTimeFormatting.friendlyFormatDateTime(new Date(opt_data.date), new Date(), Number(AJS.Meta.get('user-timezone-offset')))) + '</li></ul>';
};
if (goog.DEBUG) {
  FileViewer.Templates.Annotation.annotationReply.soyTemplateName = 'FileViewer.Templates.Annotation.annotationReply';
}


FileViewer.Templates.Annotation.annotationLike = function(opt_data, opt_ignored) {
  return '<a href="#">' + ((opt_data.liked) ? soy.$$escapeHtml('Unlike') : soy.$$escapeHtml('Like')) + '</a>';
};
if (goog.DEBUG) {
  FileViewer.Templates.Annotation.annotationLike.soyTemplateName = 'FileViewer.Templates.Annotation.annotationLike';
}


FileViewer.Templates.Annotation.annotationReplyInput = function(opt_data, opt_ignored) {
  return '<div id="cp-annotation-reply-input">' + ((! opt_data.resolved && opt_data.canReply) ? FileViewer.Templates.Annotation.annotationUserHeader({author: opt_data.author, small: true}) + FileViewer.Templates.Annotation.replyInputBox(null) : '') + '</div>';
};
if (goog.DEBUG) {
  FileViewer.Templates.Annotation.annotationReplyInput.soyTemplateName = 'FileViewer.Templates.Annotation.annotationReplyInput';
}


FileViewer.Templates.Annotation.replyInputBox = function(opt_data, opt_ignored) {
  return '<input placeholder="' + soy.$$escapeHtml('Reply') + '"></input>';
};
if (goog.DEBUG) {
  FileViewer.Templates.Annotation.replyInputBox.soyTemplateName = 'FileViewer.Templates.Annotation.replyInputBox';
}


FileViewer.Templates.Annotation.resolved = function(opt_data, opt_ignored) {
  return '<div id="cp-annotation-resolved"><p>' + soy.$$escapeHtml('Resolved') + '</p><div class="cp-resolved-info">' + soy.$$escapeHtml('Resolved feedback can be shown from the tools menu.') + '</div></div>';
};
if (goog.DEBUG) {
  FileViewer.Templates.Annotation.resolved.soyTemplateName = 'FileViewer.Templates.Annotation.resolved';
}


FileViewer.Templates.Annotation.editorLoader = function(opt_data, opt_ignored) {
  return '<form class="aui"><div class="loading-container" /></form>';
};
if (goog.DEBUG) {
  FileViewer.Templates.Annotation.editorLoader.soyTemplateName = 'FileViewer.Templates.Annotation.editorLoader';
}


FileViewer.Templates.Annotation.fileControlAnnotate = function(opt_data, opt_ignored) {
  return '<a href="#" id=\'cp-file-control-annotate\' class=\'cp-icon cp-file-control-annotate\' tabindex="14" aria-label="' + soy.$$escapeHtml('Drag this pin to add a comment') + '"><span class="tooltip tooltip-s">' + soy.$$escapeHtml('Drag this pin to add a comment') + '</span></a>';
};
if (goog.DEBUG) {
  FileViewer.Templates.Annotation.fileControlAnnotate.soyTemplateName = 'FileViewer.Templates.Annotation.fileControlAnnotate';
}

}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/js/component/utils/editor-utils.js' */
define("cp/component/utils/editor-utils",["jquery","underscore","ajs","backbone","exports"],function(e,j,g,i,c){var h=["dateautocomplete","confluencemacrobrowser","propertypanel","jiraconnector","dfe"];var a=["autoresize"];function f(){return j.clone(h)}function b(){return j.clone(a)}function k(){var l=g.Rte&&g.Rte.getEditor();if(l&&!d()){l.setDirty(true)}if(l&&l.isDirty()&&!e(".quick-comment-body .editor-container").length){return window.confirm("You have an unsaved comment on this page. Are you sure you want to continue? You will lose any unsaved changes.")}return true}function d(){if(g.Rte&&g.Rte.Content){return g.Rte.Content.isEmpty()||""===g.Rte.Content.getHtml()}else{return true}}c.getUnsupportedRtePlugins=f;c.getSupportedRtePlugins=b;c.confirmProcess=k;c.isEmpty=d});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/js/component/utils/editor.js' */
define("cp/component/utils/editor",["jquery","underscore","ajs","cp/component/utils/editor-utils","exports","MediaViewer"],function(c,q,e,h,s,a){var b;var l;var k;var g;var f;function n(u,t){if(!e.Confluence.EditorLoader.resourcesLoaded()){this.$form.find(".loading-container").spin("small")}b=a.prototype.close;t.close=function(){if(h.confirmProcess()){r();return b.apply(this,arguments)}};l=a.prototype.showFileNext;t.showFileNext=function(){if(h.confirmProcess()){r();return l.apply(this,arguments)}};k=a.prototype.showFilePrev;t.showFilePrev=function(){if(h.confirmProcess()){r();return k.apply(this,arguments)}};g=a.prototype.showFileWithCID;t.showFileWithCID=function(){if(h.confirmProcess()){r();return g.apply(this,arguments)}};f=a.prototype.showFile;t.showFile=function(){if(h.confirmProcess()){r();return f.apply(this,arguments)}};u&&u()}function j(t){e.Meta.set("content-type","comment");e.Meta.set("min-editor-height",80);e.Meta.set("use-inline-tasks","false");t&&t()}function i(u,t){t.$form.find(".loading-container").hide();t.$form.find("#rte-button-preview").hide();t.$form.find("#rte-button-publish").text("Save").removeAttr("title");t.$form.find("#rte-spinner").parent().addClass("rte-button-spinner").appendTo("#rte-savebar .toolbar-split .toolbar-split-right");t.$form.find("#toolbar-hints-draft-status").hide();t.$form.find("#wysiwygTextarea_ifr").height(e.Meta.get("min-editor-height"));e.Meta.set("min-editor-height",undefined);if(this.hideCancelButton){t.$form.find("#rte-button-cancel").hide()}u&&u();e.Confluence.QuickEdit.QuickEditPage.disable()}function o(u,t){t.close=b;t.showFileNext=l;t.showFilePrev=k;t.showFileWithCID=g;t.showFile=f;u&&u()}function m(t){return e.Confluence.QuickEdit.activateEditor({preActivate:q.partial(n,t.preActivate,t._mediaViewer),preInitialise:q.partial(j,t.preInitialise),postInitialise:q.partial(c.proxy(i,t),t.postInitialise),toolbar:false,$container:t.container,$form:t.form,saveHandler:t.saveHandler,cancelHandler:t.cancelHandler,fetchContent:t.fetchContent(),closeAnyExistingEditor:true,postDeactivate:q.partial(o,t.postDeactivate,t._mediaViewer),plugins:h.getSupportedRtePlugins(),excludePlugins:h.getUnsupportedRtePlugins()})}function r(){if(e.Rte&&e.Rte.getEditor()){if(!c(".quick-comment-body .editor-container").length){return e.Confluence.QuickEdit.deactivateEditor()}}else{return c.Deferred().resolve()}}function p(){return e.Rte.Content.getHtml()}function d(t){c(".ic-sidebar .rte-button-spinner").toggleClass("aui-icon-wait",t)}s.init=m;s.remove=r;s.getContent=p;s.setEditorBusy=d});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/js/component/utils/editor-view.js' */
define("cp/component/utils/editor-view",["backbone","underscore","jquery","cp/component/utils/editor","cp/component/utils/editor-utils"],function(f,c,d,a,e){var b=f.View.extend({initialize:function(g){this.editorSetup=g.editorSetup;this.preActivate=g.preActivate;this.preInitialise=g.preInitialise;this.postInitialise=g.postInitialise;this.container=g.container;this.saveHandler=g.saveHandler;this.cancelHandler=g.cancelHandler;this.postDeactivate=g.postDeactivate;this.content=g.content;this.errorCallback=g.error;this.restoreCallback=g.restoreCallback;this.successCallback=g.success;this._mediaViewer=g.mediaViewer;this.editorSetup&&this.editorSetup()},render:function(){a.init({preActivate:this.preActivate,preInitialise:this.preInitialise,postInitialise:this.postInitialise,container:this.container,form:this.container.find("form.aui"),saveHandler:this.saveHandler,cancelHandler:this.cancelHandler,fetchContent:function(){var g=new d.Deferred();g.resolve({editorContent:this.content});return g}.bind(this),closeAnyExistingEditor:true,postDeactivate:this.postDeactivate,_mediaViewer:this._mediaViewer}).fail(function(){this.errorCallback()}.bind(this));return this},getContent:function(){return a.getContent()},remove:function(){a.remove();return this},checkIfOpen:function(){return e.confirmProcess()},isEmpty:function(){return e.isEmpty()}});return b});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/js/component/annotation/annotation-button-view.js' */
define("cp/component/annotation/annotation-button-view",["jquery","backbone","MediaViewer","cp/component/utils/editor-utils","core/template-store-singleton"],function(d,f,c,e,a){var b=f.View.extend({events:{click:"_toggleAnnotations"},tagName:"span",initialize:function(g){this._mediaViewer=g.mediaViewer;this._model=this._mediaViewer.getCurrentFile();this._annotations=this._model.get("annotations");this.listenTo(this._annotations,"add reset sync change:resolved remove filterUpdated",this._updateAnnotationCount)},render:function(){this.$el.html(a.get("Annotation.controlAnnotationButton")());this._updateAnnotationCount();if(d.fn.tooltip){this.$("a").tooltip({gravity:"n"})}return this},_toggleAnnotations:function(g){g.preventDefault();if(this._mediaViewer.getView().fileSidebarView.isAnyPanelInitialized()){if(e.confirmProcess()){this._mediaViewer.trigger("cp.close-editor");this._mediaViewer.getView().fileSidebarView.teardownPanel()}}else{this._annotations.getCurrentOrNext();this._mediaViewer.getView().fileSidebarView.initializePanel("annotations")}},_updateAnnotationCount:function(){var g=this._annotations.getCount();this.$(".counter").text(g>9?"9+":g)}});return b});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/js/component/annotation/comments.js' */
define("cp/component/annotation/comments",["backbone","underscore","cp/component/annotation/comment"],function(e,a,c){var b=function(f){return function(g){for(var h in f){if(f[h]!==g.get(h)){return false}}return true}};var d=e.Collection.extend({model:c,initialize:function(f,g){this._current=null;this.service=g&&g.service;this._currentFilter={resolved:false};if(g&&g.fileModel){this.fileModel=g.fileModel}this.listenTo(this,"remove",this.selectNextIfRemoved)},comparator:function(h){var f=h.get("position");var g=h.get("pageNumber");return[g,f[1],f[0]]},selectNextIfRemoved:function(f){if(this._current===f){this.next()}},fetchComments:function(){if(this.size()===0){return this.fetch()}else{return $.when()}},sync:function(i,h){if(!this.service){return}if(i==="read"){var g=h.service.getAnnotations(),f=this;g&&g.done(function(j){j=a.map(j,function(k){return new c(k,{service:f.service})});h.reset(j,{silent:true});h.trigger("sync",h)});return g}},currentIndexOfWhere:function(g,f){return f?this.where(f).indexOf(g):this.indexOf(g)},nextWhere:function(h){var g=this.indexOf(this._current);var f=this.chain().rest(g+1).filter(b(h)).first().value();f=f||this.chain().filter(b(h)).first().value();this.setSelected(f);return f},prevWhere:function(h){var g=this.indexOf(this._current);var f=this.chain().first(Math.max(g,0)).filter(b(h)).last().value();f=f||this.chain().filter(b(h)).last().value();this.setSelected(f);return f},currentIndexOf:function(f){return this.currentIndexOfWhere(f,this._currentFilter)},next:function(){return this.nextWhere(this._currentFilter)},prev:function(){return this.prevWhere(this._currentFilter)},getCurrent:function(){return this._current},getCurrentOrNext:function(){if(!this._current||!this.isFiltered(this._current)){this._current=this.next()}return this.getCurrent()},isFiltered:function(f){var g=b(this.getFilter());return g(f)},selectCommentWithId:function(g,f){var h=this.findWhere({id:g});if(h&&h.get("resolved")){this.setFilter()}if(f){h.replies.selectReplyWithId(f)}this.setSelected(h);this.trigger("pinSelected")},setSelected:function(g,f){this.invoke("set",{selected:false});this._current=null;if(g){g.set({selected:true});this._current=g;g.replies.fetch();!f&&this.trigger("selected",g)}else{!f&&this.trigger("unselected")}},setResolved:function(f){f.set({resolved:true})},getCountWhere:function(f){return f?this.where(f).length:this.size()},getCount:function(){return this.getCountWhere(this._currentFilter)},setFilter:function(f){this._currentFilter=f;this.trigger("filterUpdated");return this},getFilter:function(){return this._currentFilter}});return d});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/js/component/annotation/comment.js' */
define("cp/component/annotation/comment",["cp/component/annotation/replies","cp/component/annotation/likes","ajs","backbone"],function(b,d,a,e){var c=e.Model.extend({defaults:{author:{name:"",avatar:"",profile:""},comment:"",date:new Date(),pageNumber:1,position:[0.5,0.5],resolved:false,selected:false,hasEditPermission:true,hasResolvePermission:true,hasDeletePermission:true,hasReplyPermission:true},initialize:function(f,g){this.service=g.service;if(this.service){this.replies=new b(undefined,{service:this.service,parentModel:this})}else{this.replies=new b()}this.likes=new d([],{contentId:this.get("id"),replies:this.replies.models});this.on("change:id",this.createLikes);this.listenTo(this.replies,"reset sync",this.createLikes);this.createLikes();this.set("fileModel",f.fileModel)},createLikes:function(){if(!this.replies.isSynced()){return}if(this.get("id")!==undefined){this.likes.setReplies(this.replies.models);this.likes.fetch()}},setResolved:function(f){this.save({resolved:f})},isNew:function(){return this.get("isNew")},sync:function(i,g,f){if(!this.service){return}if(i==="create"||i==="update"){var h=g.service.save(g);h.done(function(j){g.set(j);g.service.sendTrackEvent(g);f.success()}).fail(function(){f.error()});return h}else{if(i==="delete"){var h=g.service.remove(g);h.done(function(){f.success()}).fail(function(){f.error()});return h}}}});return c});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/js/component/annotation/webpanels.js' */
define("cp/component/annotation/webpanels",["backbone","cp/component/annotation/webpanel","ajs"],function(d,c,a){var b=d.Collection.extend({model:c,url:a.contextPath()+"/rest/experimental/webfragment/panels?location=atl.page.content.footer.actions",});return b});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/js/component/annotation/webpanel.js' */
define("cp/component/annotation/webpanel",["backbone"],function(b){var a=b.Model.extend({});return a});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/js/component/annotation/replies.js' */
define("cp/component/annotation/replies",["backbone","underscore","cp/component/annotation/reply"],function(d,b,a){var c=d.Collection.extend({initialize:function(e,f){this.parentModel=f.parentModel;this.service=f&&f.service;this.synced=false;this._skipFetch=false},sync:function(j,h,e){var i=h.parentModel&&h.parentModel.get("id");if(e.force){this._skipFetch=false}if(!this.service||!i||this._skipFetch){return}if(j==="read"){this._skipFetch=true;var g=h.service.getReplies({parentId:i}),f=this;g.done(function(k){k=b.map(k,function(l){return new a(l,{service:f.service})});this.synced=true;h.reset(k)}.bind(this)).fail(function(){this.synced=false;this._skipFetch=false}.bind(this))}},addReply:function(g,e){var f=new a(g,{service:this.service});this.setSelected(f);this.add(f);f.save(null,{wait:true,error:e.error})},selectReplyWithId:function(e){if(!this.isSynced()){this.listenToOnce(this,"reset",function(){this.setSelected(this.findWhere({id:e}))})}else{this.setSelected(this.findWhere({id:e}))}},setSelected:function(e){this.invoke("set",{selected:false});if(e){e.set("selected",true)}},isSynced:function(){return this.synced}});return c});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/js/component/annotation/reply.js' */
define("cp/component/annotation/reply",["backbone","cp/component/annotation/likes"],function(c,b){var a=c.Model.extend({defaults:{author:"",comment:"",date:new Date(),resolved:false,hasEditPermission:false,hasDeletePermission:false},initialize:function(d,e){this.service=e.service},sync:function(g,e,d){if(!this.service){return}if(g==="create"||g==="update"){var f=e.service.save(e);f.done(function(h){e.set(h);e.service.sendTrackEvent(e);d.success()}).fail(function(){d.error()});return f}else{if(g==="delete"){var f=e.service.remove(e);f.done(function(h){d.success()}).fail(function(){d.error()});return f}}}});return a});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/js/component/annotation/annotation-view.js' */
define("cp/component/annotation/annotation-view",["backbone","underscore","jquery","ajs","cp/component/annotation/annotation-header-view","cp/component/annotation/comment-view","cp/component/annotation/add-annotation-view","MediaViewer","core/template-store-singleton"],function(g,h,d,f,i,a,e,b,j){var c=g.View.extend({id:"cp-annotations",tagName:"div",initialize:function(k){this._mediaViewer=k.mediaViewer;this.fileSidebarView=k.panelView;this.model=this._mediaViewer.getCurrentFile();this.annotations=this.model.get("annotations");this.webpanels=this.model.get("webpanels");this.listenTo(this.annotations,"reset sync selected unselected add remove",this.render);this.listenTo(this.annotations,"pinSelected",this.show);this.listenTo(this.annotations,"filterUpdated",this.updateWithFiltered);this.listenTo(this._mediaViewer,"cp.close-editor",this._closeEditor);this.show();this.render()},teardown:function(){this.hide();this.commentView&&this.commentView.off().remove();this.addAnnotationView&&this.addAnnotationView.teardown()&&this.addAnnotationView.off().remove()},hide:function(){d("#cp-control-panel-annotations").removeClass("focused");this.annotations.setSelected();this._mediaViewer._fileState.trigger("cp.hideAnnotations")},show:function(){d("#cp-control-panel-annotations").addClass("focused")},addAnnotation:function(l){if(!this.canOpenNewEditor()){d("#cp-file-control-annotate").draggable("option","disabled",false);return}this.show();this.annotations.setSelected();var k=this._mediaViewer.getCurrentFile().createAnnotation({author:this.currentUser,position:[l.x,l.y],pageNumber:l.pageNumber,isNew:true});this.annotations.setSelected(k,true);this.addAnnotationView=new e({annotation:k,collection:this.annotations,mediaViewer:this._mediaViewer,annotationView:this});this.$el.html(this.addAnnotationView.$el);this.addAnnotationView.render();this.$el.find("textarea.cp-add-annotation").focus()},render:function(){var k=true;if(f.DarkFeatures.isEnabled("optional-likes-CONFDEV-53297")&&this.webpanels){k=this.webpanels.length>0}if(this.annotations){var l=this.annotations.getCurrent();if(!l){this.$el.html(j.get("Annotation.blankAnnotation")())}else{this.headerView=new i({model:this.model,annotationView:this});this.commentView=new a({model:l,annotationView:this,shouldShowLike:k});this.$el.empty().append(this.headerView.render().$el).append(this.commentView.render().el)}}f.trigger("ic-jim-async-supported");return this},_generateError:function(k){this.headerView._generateError(k)},canOpenNewEditor:function(){return !this._editorView||this._editorView.checkIfOpen()},isCommentVisible:function(k){return this.annotations.isFiltered(k)},clearErrorFlags:function(){this.headerView._clearError()},_closeEditor:function(){this._editorView&&this._editorView.remove()},updateWithFiltered:function(){this.annotations.getCurrentOrNext();this.render()}});return c});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/js/component/annotation/pin-view.js' */
define("cp/component/annotation/pin-view",["backbone","jquery","cp/component/annotation/comment","cp/component/utils/editor-utils"],function(e,b,c,d){var a=e.View.extend({model:c,tagName:"span",className:"cp-icon cp-active-annotation",events:{click:"clickPin"},clickPin:function(){if(d.confirmProcess()){var f=this._mediaViewer.getView().fileSidebarView;if(this.model.get("selected")&&f.isPanelInitialized("annotations")){this.closeSidebar()}else{this.showPin();this._mediaViewer.trigger("cp.close-editor")}}},closeSidebar:function(){this.collection.setSelected();this._mediaViewer.trigger("cp.close-editor");this._mediaViewer.getView().fileSidebarView.teardownPanel()},showPin:function(){this.collection.setSelected(this.model);this.collection.trigger("pinSelected");this._mediaViewer._fileState.trigger("cp.showAnnotations")},initialize:function(f){this._mediaViewer=f.mediaViewer;this.calculatePosition=f.calculatePosition;this.listenTo(this.model,"sync",this.render);this.listenTo(this.model,"change:resolved",this.setResolved);this.listenTo(this.model,"change:selected",this.setAnimate)},setResolved:function(){var f=this.model.get("resolved");this.$el.toggleClass("resolved",f)},setSelected:function(){var f=this.model.get("selected");this.$el.toggleClass("selected",f)},setAnimate:function(){var f=this.model.get("selected");this.setSelected();this.$el.toggleClass("animate",f)},setPosition:function(){var g;if(this.calculatePosition){g=this.calculatePosition(this.model.toJSON())}else{var h=this.model.get("position");var f=h[0]*100;var i=h[1]*100;g={x:f+"%",y:i+"%"}}this.$el.css("top",g.y);this.$el.css("left",g.x)},render:function(){this.$el.attr("data-comment-id",this.model.get("id"));this.setPosition();this.setResolved();this.setSelected();return this}});return a});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/js/component/annotation/pins-view.js' */
define("cp/component/annotation/pins-view",["backbone","jquery","underscore","cp/component/annotation/comments","cp/component/annotation/pin-view"],function(g,d,b,f,a){var c=function(h){return function(i){for(var j in h){if(h[j]!==i.get(j)){return false}}return true}};var e=g.View.extend({collection:f,initialize:function(h){this.container=h.container;this.filter=h.filter;this.calculatePosition=h.calculatePosition;this.collection=h.collection;this.annotationPins=[];this._mediaViewer=h.mediaViewer;this.listenTo(this.collection,"reset sync add remove",this.markRetrieved);this.listenTo(this.collection,"reset sync add remove",this.render);this.listenTo(this.collection,"filterUpdated",this.render)},markRetrieved:function(){d(this.container).attr("data-pins-retrieved",true)},render:function(){this.unbindAnnotationPins();var i=this.filter?b.filter(this.collection.models,this.filter):this.collection.models,h=this;b.chain(i).filter(c(this.collection.getFilter())).each(function(j){var k=new a({calculatePosition:h.calculatePosition,model:j,collection:h.collection,mediaViewer:this._mediaViewer});h.annotationPins.push(k);d(k.render().el).prependTo(h.container)},this)},unbindAnnotationPins:function(){while(this.annotationPins.length>0){var h=this.annotationPins.pop();h.remove().off()}},off:function(i,j,h){this.unbindAnnotationPins();return g.Collection.prototype.off.call(this,i,j,h)}});return e});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/js/component/annotation/reply-view.js' */
define("cp/component/annotation/reply-view",["backbone","underscore","jquery","cp/component/annotation/reply","cp/component/utils/editor-view","cp/component/annotation/likes-view","MediaViewer","core/template-store-singleton"],function(f,g,d,b,i,a,c,h){var e=f.View.extend({model:b,tagName:"div",className:"cp-annotation-reply",events:{"click .cp-annotation-edit":"editReply","click .cp-annotation-delete":"deleteReply"},initialize:function(j){this.listenTo(this.model,"change",this.render);this.listenTo(this.model,"remove",this.remove);this._annotationView=j.annotationView;this._parentView=j.commentView},render:function(){if(!this.model.get("id")){return this}this.$el.html(h.get("Annotation.annotationReply")({id:this.model.get("id"),canEdit:this.model.get("hasEditPermission"),canDelete:this.model.get("hasDeletePermission"),author:this.model.get("author"),comment:this.model.get("comment"),date:this.model.get("date"),resolved:this._parentView._isResolved()}));if(this.model.get("selected")){this.$el.addClass("selected")}else{this.$el.removeClass("selected")}this.showLikes();AJS.trigger("ic-jim-async-supported");return this},showLikes:function(){if(this.options.shouldShowLike){var j=new a({el:this.$el.find(".cp-annotation-reply-like"),id:this.model.get("id"),collection:this._parentView.model.likes,_annotationView:this._annotationView});j.render()}},editReply:function(){if(!this._annotationView.canOpenNewEditor()){return}var j=this.model.get("editorFormat");this.editorView=this._annotationView._editorView=new i({editorSetup:function(){var k=d(h.get("Annotation.editorLoader")());this.$el.find(".cp-annotation-comment").replaceWith(k);this.$el.find(".cp-annotation-actions").hide()}.bind(this),container:this.$el,saveHandler:g.bind(this.saveReply,this),cancelHandler:g.bind(this.restore,this),postDeactivate:g.bind(this.restore,this),content:j,errorCallback:g.bind(this._handleEditorError,this),restoreCallback:g.bind(this.restore,this),mediaViewer:this._annotationView._mediaViewer});this.editorView.render()},saveReply:function(j){j&&j.preventDefault();if(this.editorView.isEmpty()){this._generateError("You cannot save an empty comment.");return}this._annotationView.clearErrorFlags();this.model.set({editorFormat:this.editorView.getContent()},{silent:true});this.model.save(null,{wait:true,success:this.restore.bind(this),error:this._handleError.bind(this)});this.editorView&&this.editorView.remove()},restore:function(j){j&&j.preventDefault&&j.preventDefault();this.editorView&&this.editorView.remove();this.render()},deleteReply:function(){var j=window.confirm("Are you sure you want to delete the reply?");if(j){this.model.destroy({wait:true,error:this._handleError.bind(this)})}},_handleError:function(){this._generateError("Error: There was a problem saving your changes.")},_handleEditorError:function(){this._generateError("Error: Could not open the editor.")},_generateError:function(j){this._annotationView._generateError(j)}});return e});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/js/component/annotation/comment-view.js' */
define("cp/component/annotation/comment-view",["backbone","underscore","jquery","ajs","cp/component/annotation/comment","cp/component/annotation/reply-view","MediaViewer","cp/component/annotation/likes-view","cp/component/utils/editor-view","core/template-store-singleton"],function(h,i,e,g,d,f,c,a,k,j){var b=h.View.extend({model:d,tagName:"div",className:"cp-comment-view cp-editor",events:{"click input":"convertToEditor","click #cp-top-level-annotation .cp-annotation-edit":"editComment","click .cp-annotation-resolve":"resolve"},initialize:function(l){this.listenTo(this.model.replies,"reset add",this.showReplies);this.listenTo(this.model,"change",this.render);this.listenTo(this.model,"likesReady",this.showLikes);this.currentUser={name:g.Meta.get("current-user-fullname"),avatar:g.Meta.get("current-user-avatar-uri-reference"),profile:g.contextPath()+"/display/~"+g.Meta.get("remote-user")};this._annotationView=l.annotationView},renderComment:function(){return j.get("Annotation.topLevelAnnotation")({id:this.model.get("id"),author:this.model.get("author"),comment:this.model.get("comment"),canEdit:this.model.get("hasEditPermission"),canResolve:this.model.get("hasResolvePermission"),resolved:this.model.get("resolved"),date:this.model.get("date")})},renderTopLevelAnnotation:function(){this.$el.find("#cp-top-level-annotation").replaceWith(this.renderComment());this.showLikes()},render:function(){if(!this.model.get("id")){return this}if(this._annotationView.isCommentVisible(this.model)){this.$el.html(this.renderComment());e(j.get("Annotation.annotationReplyInput")({author:this.currentUser,canReply:this.model.get("hasReplyPermission"),resolved:this.model.get("resolved")})).appendTo(this.$el);this.showReplies();this.showLikes()}else{if(this.model.get("resolved")){this.$el.html(j.get("Annotation.resolved")())}}return this},editComment:function(m){if(!this._annotationView.canOpenNewEditor()){return}var l=this.model.get("editorFormat");this.editorView=this._annotationView._editorView=new k({editorSetup:function(){var n=e(j.get("Annotation.editorLoader")());this.$el.find("#cp-annotation-main-comment").replaceWith(n);this.$el.find("#cp-top-level-annotation .cp-annotation-actions").hide()}.bind(this),container:this.$el.find("#cp-top-level-annotation"),form:this.$el.find("form.aui"),saveHandler:i.bind(this.saveEdit,this),cancelHandler:i.bind(this.cancelHandler,this),content:l,postDeactivate:i.bind(this.restoreCommentOnly,this),errorCallback:i.bind(this._handleEditorError,this),restoreCallback:i.bind(this.completedHandler,this),mediaViewer:this._annotationView._mediaViewer});this.editorView.render()},saveEdit:function(l){l&&l.preventDefault();if(this.editorView.isEmpty()){this._generateError("You cannot save an empty comment.");return}this.model.set({editorFormat:this.editorView.getContent()},{silent:true});this.model.save(null,{wait:true,success:this.restoreActions.bind(this),error:this._handleError.bind(this)});this.editorView&&this.editorView.remove()},cancelHandler:function(l){this.completedHandler(l);g.trigger("ic-jim-async-supported")},completedHandler:function(l){this.restoreActions();l.preventDefault()},restoreActions:function(){this.$el.find("#cp-top-level-annotation .cp-annotation-actions").show();this.editorView&&this.editorView.remove()},restoreCommentOnly:function(l){this.$el.find("#cp-top-level-annotation .cp-annotation-actions").show();this.renderTopLevelAnnotation()},showLikes:function(){if(this.options.shouldShowLike){var l=this.model.likes;var m=new a({el:this.$el.find(".cp-annotation-comment-like"),id:this.model.get("id"),collection:l,_annotationView:this._annotationView});m.render()}},convertToInputBox:function(l){l&&l.preventDefault();var m=e(j.get("Annotation.replyInputBox")());this.$el.find("form.aui").replaceWith(m);this.editorView&&this.editorView.remove()},restoreAfterEditorDeactivate:function(l){var m=e(j.get("Annotation.replyInputBox")());this.$el.find("form.aui.fadeIn").replaceWith(m)},convertToEditor:function(){if(!this._annotationView.canOpenNewEditor()){return}this.editorView=this._annotationView._editorView=new k({editorSetup:function(){var l=e(j.get("Annotation.editorLoader")());this.$el.find("input").replaceWith(l)}.bind(this),container:this.$el,saveHandler:i.bind(this.saveReply,this),cancelHandler:i.bind(this.convertToInputBox,this),content:"",postDeactivate:i.bind(this.restoreAfterEditorDeactivate,this),errorCallback:i.bind(this._handleEditorError,this),restoreCallback:function(){e("input").blur()},mediaViewer:this._annotationView._mediaViewer});this.editorView.render()},resolve:function(){if(this.model.get("resolved")){g.trigger("analyticsEvent",{name:"confluence-spaces.previews.annotation.unresolve",data:{fileType:this._annotationView._mediaViewer.getCurrentFile().get("type"),commentId:this.model.get("id"),replyCount:this.model.replies.length,isProject:!!(g.Meta.get("space-type")==="project"&&e('[data-internal-id="tab-files"]').length)}});this.model.setResolved(false)}else{if(!this._annotationView.canOpenNewEditor()){return}g.trigger("analyticsEvent",{name:"confluence-spaces.previews.annotation.resolve",data:{fileType:this._annotationView._mediaViewer.getCurrentFile().get("type"),commentId:this.model.get("id"),replyCount:this.model.replies.length,isProject:!!(g.Meta.get("space-type")==="project"&&e('[data-internal-id="tab-files"]').length)}});this.model.setResolved(true);this._annotationView._closeEditor()}},saveReply:function(m){m&&m.preventDefault();var l=this.model.replies;if(this.editorView.isEmpty()){this._generateError("You cannot save an empty comment.");return}this._annotationView.clearErrorFlags();l.addReply({author:this.currentUser,editorFormat:this.editorView.getContent(),parentId:this.model.get("id")},{error:this._handleError.bind(this)});g.trigger("analyticsEvent",{name:"confluence-spaces.previews.annotation.reply",data:{commentId:this.model.get("id"),isProject:!!(g.Meta.get("space-type")==="project"&&e('[data-internal-id="tab-files"]').length)}});this.convertToInputBox()},showReplies:function(){this.$el.find(".cp-annotation-reply").remove();var m=this.model.replies,l=this;i.each(m.models,function(o){var n=new f({model:o,annotationView:l._annotationView,commentView:l,shouldShowLike:l.options.shouldShowLike,});l.$el.find("#cp-annotation-reply-input").before(n.render().el)})},_handleError:function(){this._generateError("Error: There was a problem saving your changes.")},_handleEditorError:function(){this._generateError("Error: Could not open the editor.")},_generateError:function(l){this._annotationView._generateError(l)},_isResolved:function(){return this.model.get("resolved")}});return b});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/js/component/annotation/annotation-header-view.js' */
define("cp/component/annotation/annotation-header-view",["backbone","underscore","jquery","ajs","MediaViewer","core/template-store-singleton"],function(g,b,f,a,d,c){var e=g.View.extend({tagName:"div",className:"cp-annotation-header",events:{"click #cp-annotation-next":"next","click #cp-annotation-previous":"previous"},initialize:function(h){this.annotations=this.model.get("annotations");this.current=this.annotations.getCurrent();this._annotationView=h.annotationView;this.listenTo(this.annotations,"filterUpdated",this.render)},next:function(){this.annotations.next()},previous:function(){this.annotations.prev()},render:function(){this.$el.html(c.get("Annotation.annotationHeader")({current:this.annotations.currentIndexOf(this.current)+1,total:this.annotations.getCount(),canDelete:this.current.get("hasDeletePermission"),resolved:this.current.get("resolved")}));f(".tipsy").remove()&&f.fn.tooltip&&this.$el.find("a").tooltip();var h=b.bind(this.deleteComment,this);this.$el.find("#cp-annotations-more-menu").on({"aui-dropdown2-show":function(){f("body").on("click","#cp-annotation-delete",h)},"aui-dropdown2-hide":function(){f("body").off("click","#cp-annotation-delete",h)}});return this},deleteComment:function(h){h.preventDefault();var i=window.confirm("Are you sure you want to delete the comment?");if(i){this._annotationView._closeEditor();this.annotations.getCurrent().destroy({wait:true,error:this._handleError.bind(this)})}},_handleError:function(){this._generateError("Error: There was a problem saving your changes.")},_generateError:function(h){this._clearError();a.messages.warning(".cp-error",{body:h})},_clearError:function(){f(".cp-error").empty()}});return e});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/js/component/annotation/add-annotation-view.js' */
define("cp/component/annotation/add-annotation-view",["backbone","underscore","jquery","ajs","cp/component/utils/editor-view","cp/component/utils/editor-utils","MediaViewer","core/template-store-singleton"],function(g,h,b,f,j,c,a,i){var e=a.prototype.changeMode;var d=g.View.extend({tagName:"div",id:"cp-add-annotation",events:{},initialize:function(k){this._mediaViewer=k.mediaViewer;this._annotationView=k.annotationView;this.currentUser={name:f.Meta.get("current-user-fullname"),avatar:f.Meta.get("current-user-avatar-uri-reference"),profile:f.contextPath()+"/display/~"+f.Meta.get("remote-user")};this._annotation=k.annotation;this.listenTo(this._mediaViewer._fileState,"cp.hideAnnotations",this.clearAnnotation);this.listenTo(this._mediaViewer,"fv.close",this.clearAnnotation);this.listenTo(this.collection,"pinSelected",this.teardown)},render:function(){this.editorView=this._annotationView._editorView=new j({editorSetup:function(){this.$el.html(i.get("Annotation.addAnnotation")({author:this.currentUser}))}.bind(this),container:this.$el,saveHandler:h.bind(this.saveAnnotation,this),cancelHandler:h.bind(this.cancelAnnotation,this),content:"",restoreCallback:h.bind(this.cancelAnnotation,this),mediaViewer:this._mediaViewer});this.editorView.render();var k=this;this._mediaViewer.changeMode=function(){if(c.confirmProcess()){k.cancelAnnotation();return e.apply(this,arguments)}};return this},cancelAnnotation:function(k){k&&k.preventDefault();this.removeNewAnnotation();this.collection.setSelected(this.collection.getCurrentOrNext())},removeNewAnnotation:function(){this.clearAnnotation();this._annotation.destroy();this.editorView&&this.editorView.remove();this._mediaViewer.changeMode=e},clearAnnotation:function(){this._mediaViewer.getView().$el.find("#cp-file-control-annotate").draggable("option","disabled",false)},saveAnnotation:function(k){k&&k.preventDefault();if(this.editorView.isEmpty()){this._generateError("You cannot save an empty comment.");return}this._annotation.set("editorFormat",this.editorView.getContent(),{silent:true});this._annotation.set("isNew",false);this._annotation.save();this.editorView&&this.editorView.remove();this.clearAnnotation();f.trigger("analyticsEvent",{name:"confluence-spaces.previews.annotation.comment",data:{fileType:this._mediaViewer.getCurrentFile().get("type"),attachmentId:this._mediaViewer.getCurrentFile().get("id"),isProject:!!(f.Meta.get("space-type")==="project"&&b('[data-internal-id="tab-files"]').length)}});this.collection.setSelected(this._annotation);this._mediaViewer.changeMode=e},teardown:function(){if(this._annotation.isNew()){this.removeNewAnnotation()}else{this.clearAnnotation()}return this},_generateError:function(k){b(".cp-error").empty();f.messages.warning(".cp-error",{body:k})}});return d});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/js/component/annotation/likes.js' */
define("cp/component/annotation/likes",["backbone","underscore","jquery","cp/component/annotation/like","ajs"],function(f,c,d,b,a){var e=f.Collection.extend({model:b,initialize:function(h,g){this.contentId=g.contentId;this.replies=g.replies?g.replies:[];this._skipFetch=false},addLike:function(h,g){var i=c.find(this.models,function(j){return j.get("content_id")===h});if(!i){i=new b();this.add(i)}i.save(null,{id:h,wait:true,error:g.error})},removeLike:function(h,g){var i=c.find(this.models,function(j){return j.get("content_id")===h});i.id="";i.destroy({id:h,wait:true})},sync:function(k,j,h){if(h.force){this._skipFetch=false}if(this._skipFetch||!j.contentId){return}if(k==="read"){this._skipFetch=true;var i=this._getCommentIds();var g=d.Deferred();d.ajax({url:a.contextPath()+"/rest/likes/1.0/content/likes",type:"POST",data:JSON.stringify(i),contentType:"application/json"}).then(function(m){var l=c.map(m,function(n){return new b(n)});j.reset(l);g.resolve(l)}).fail(function(l,n,m){this._skipFetch=false;g.reject(l,n,m)}.bind(this))}},setReplies:function(g){this.replies=g},_getCommentIds:function(){var g=[];g.push(this.contentId);if(this.replies){c.each(this.replies,function(h){g.push(h.get("id"))})}return{ids:g}}});return e});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/js/component/annotation/like.js' */
define("cp/component/annotation/like",["backbone","jquery","ajs"],function(d,c,a){var b=d.Model.extend({defaults:{content_id:"",content_type:"",likes:[],summary:""},sync:function(g,f,e){if(g!=="create"&&g!=="update"&&g!=="delete"){throw"Unsupported method in likes model: "+g}return c.ajax({url:a.contextPath()+"/rest/likes/1.0/content/"+e.id+"/likes",type:g==="create"||g==="update"?"POST":"DELETE",contentType:"application/json"}).done(function(h){f.set(h);f.trigger("sync",f,h,e)}).error(function(){e.error&&e.error()})}});return b});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/js/component/annotation/likes-view.js' */
define("cp/component/annotation/likes-view",["backbone","jquery","underscore","ajs","cp/component/annotation/comments","MediaViewer","cp/component/annotation/likes","core/template-store-singleton"],function(g,e,h,f,d,c,b,i){var a=g.View.extend({collection:b,tagName:"span",className:"cp-annotation-like",events:{"click .cp-annotation-like":"like","click .cp-annotation-unlike":"unlike"},initialize:function(j){this.collection=j.collection;this.commentId=j.id;this._annotationView=j._annotationView;this.collection&&this.listenTo(this.collection,"reset add remove sync",this.render)},render:function(){this.$el.empty();if(this.collection===undefined){return}var k=h.find(this.collection.models,function(m){return m.attributes.content_id===this.commentId}.bind(this));var l=!!k&&h.some(k.get("likes"),function(m){return m.user.name===f.Meta.get("remote-user")});var j=k?k.get("likes").length:0;this.$el.html(i.get("Annotation.likes")({likes:j,hasLiked:l}));return this},like:function(){f.trigger("analyticsEvent",{name:"confluence-spaces.previews.annotation.like",data:{fileType:this._annotationView._mediaViewer.getCurrentFile().get("type"),commentId:this.commentId,isProject:!!(f.Meta.get("space-type")==="project"&&e('[data-internal-id="tab-files"]').length)}});this.collection.addLike(this.commentId,{error:this._handleError.bind(this)})},unlike:function(){this.collection.removeLike(this.commentId)},_handleError:function(){this._annotationView._generateError("Error: Unable to save your like.")}});return a});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/js/component/annotation/content-view.js' */
define("cp/component/annotation/content-view",["MediaViewer","backbone","underscore","jquery"],function(a,g,h,d){var c=500;var b=c-100;var i={PLUS:187,MINUS:189,PLUS_NUMPAD:107,MINUS_NUMPAD:109,PLUS_FF:61,MINUS_FF:173};var e=a.require("core/base_viewer");var f={annotationEvents:{"mousemove.contentView.show":"_showControlsOnMove","mousemove.contentView.hide":"_hideControlsOnMove"},initialize:function(){this.events=h.extend(this.events||{},this.annotationEvents);this._toggleControlsTimeout=null;this._autoToggleControls=true;d(document).on("keydown.viewerZoom",this._handleKeyboardZoom.bind(this))},_showControlsOnMove:h.throttle(function(){if(!this._autoToggleControls){return}this.showControls()},b),_hideControlsOnMove:h.throttle(function(){if(!this._autoToggleControls){return}this.hideControls()},b),showControls:function(){if(!this.getControlsElement){return}clearTimeout(this._toggleControlsTimeout);this.getControlsElement().show()},hideControls:function(){if(!this.getControlsElement){return}this._toggleControlsTimeout=this._setHideTimer()},_setHideTimer:function(){return setTimeout(function(){if(this.getControlsElement().is(":hover")){return}this.getControlsElement().fadeOut()}.bind(this),c)},autoToggleControls:function(j){this._autoToggleControls=j;if(!this._autoToggleControls){clearTimeout(this._toggleControlsTimeout)}},_handleKeyboardZoom:function(j){var k=(j.ctrlKey||j.metaKey);if(this.zoomIn&&k&&(j.which===i.PLUS||j.which===i.PLUS_NUMPAD||j.which===i.PLUS_FF)){this.zoomIn();j.preventDefault()}if(this.zoomOut&&k&&(j.which===i.MINUS||j.which===i.MINUS_NUMPAD||j.which===i.MINUS_FF)){this.zoomOut();j.preventDefault()}}};Object.keys(f).forEach(function(j){e[j]=f[j]});return e});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:annotation-plugin', location = '/js/component/annotation/annotation-plugin.js' */
define("cp/component/annotation/annotation-plugin",["MediaViewer","cp/component/annotation/annotation-view","cp/component/annotation/annotation-button-view","cp/component/annotation/pins-view","cp/component/annotation/comments","cp/component/annotation/comment","cp/component/annotation/content-view","cp/component/annotation/webpanels","underscore","jquery","ajs","core/template-store-singleton"],function(b,e,n,f,d,c,g,i,l,h,k,m){var j=b.require("viewers/unknown-file-type-view/unknown-file-type-view");var a=function(v){var t=v.getConfig();if(!t.enableAnnotations||!t.commentService){return}var B=t.commentService;g.prototype.annotationOptions={dropTarget:".cp-annotatable"};v.getView().fileSidebarView.addPanelView("annotations",e);var C=v.getView().fileControlsView;var q=v.getView().fileSidebarView;var y=function(){var D=v.getCurrentFile();return !D.get("isRemoteLink")};C.addLayerView("annotationButton",n,{predicate:y,weight:5});var s=a.showAnnotationsPanel;v._fileState.on("cp.showAnnotations",l.partial(s,v));var r=function(D){if(D.createAnnotation){return}D.set("annotations",new d([],{service:new B(D.get("id"),D.get("version")),fileModel:D}));var E=new i();E.fetch().done(function(G){D.set("webpanels",G)});if(b.isPluginEnabled("permalink")){var F=b.getPlugin("permalink");D.get("annotations").on("selected",function(G){if(G.get("id")){F.setRouteForPin(D,G)}else{G.on("change:id",function(){F.setRouteForPin(D,G)})}})}D.on("change:id",function(){this.get("annotations").service=new B(D.get("id"),D.get("version"))});D.createAnnotation=function(J){var I=l.extend(J,{fileModel:this});var K=this.get("annotations");var H=new B(D.get("id"),D.get("version"));var G=new c(I,{service:H});K.add(G);return G}.bind(D)};v.getView().on("fv.fileChange",r);var A=function(E){var D=v.getCurrentFile();if(D.get("annotations").where({resolved:true}).length>0){E.addFileAction({key:"resolved.toggle",text:"Show resolved comments",callback:function(){D.get("annotations").setFilter();z(E)}.bind(this)})}};var z=function(E){var D=v.getCurrentFile();E.addFileAction({key:"resolved.toggle",text:"Hide resolved comments",callback:function(){D.get("annotations").setFilter({resolved:false});A(E)}.bind(this)})};var x=function(D,F){if(!v.isOpen()){return}var E=F.getFilter();if(l.isEqual(E,{resolved:false})){A(D)}else{z(D)}};var w;v.close=l.wrap(v.close,function(D){if(w){return}D.apply(v,Array.prototype.slice.call(arguments,1))});v.showFile=l.wrap(v.showFile,function(D){if(w){return}return D.apply(v,Array.prototype.slice.call(arguments,1))});var p=false;var o=function(V){var I=v.getView().fileContentView.getLayerForName("content")._viewer;if(!I){return}if(!y()||I instanceof j){if(I instanceof j){C.getLayerForName("annotationButton").$el.hide()}q.teardownPanel();return}var O=h(".cp-toolbar");var P=O.find("#cp-file-control-annotate");if(P.length===0&&(V.get("hasReplyPermission")||V.get("hasReplyPermission")===undefined)){P=h(m.get("Annotation.fileControlAnnotate")());h.fn.tooltip&&P.tooltip({gravity:"s"});P.appendTo(O);O.css("margin-left",-O.width()/2)}V.trigger("cp.control-added",{plugin:"annotation"});I=l.extend(I,g);if(!p&&!h(".cp-annotatable .cp-active-annotation").length){I.renderAnnotations&&I.renderAnnotations(f);p=true}var U=C.getLayerForName("moreButton");var D=V.get("annotations");x(U,D);D.on("sync change:resolved filterUpdated",l.partial(x,U,D));D.fetchComments().done(function(){if(v.getView().fileSidebarView.isPanelInitialized("annotations")){D.getCurrentOrNext()}});var Q=I.annotationOptions.dropTarget;var H=I.annotationOptions.annotationCreated;var F=function(aa,ad){ad.helper.addClass("active");var ab=h(this);var Z=ab.offset();var ag=aa.pageX-Z.left;var ae=aa.pageY-Z.top;var af=ag/ab.width();var ac=ae/ab.height();var X;if(H){X=H(this,aa)}X=l.extend({},X,{x:af,y:ac});var Y=(X.x*100)+"%";var W=(X.y*100)+"%";ab.closest(Q).append(ad.helper.detach());ad.helper.css({left:Y,top:W});v._fileState.trigger("cp.showAnnotations");v.getView().$el.find("#cp-file-control-annotate,#cp-control-panel-annotations").draggable("option","disabled",true);q.getInitializedPanel("annotations").addAnnotation(X)};var N=v.getView().$el.find("#cp-file-control-annotate");var K=N.draggable({appendTo:v.getView().el,helper:function(){return h("<div class='annotation-pin'></div>")},cursor:"-webkit-grabbing",cursorAt:{left:0,top:0},scroll:false,stack:"img",revert:"invalid",start:function(){w=true;I.autoToggleControls(false);I.hideControls();h(Q).droppable({tolerance:"pointer",drop:F})},stop:function(){w=false;I.showControls();I.autoToggleControls(true);h(Q).droppable("destroy")}});var L=K.data("draggable");if(L&&L._mouseUp&&L._mouseMove&&L._trigger&&L._clear){var G;var J=function(W){if(!w&&!L.options.disabled){L._mouseStart.call(L,W);w=true;G=W;E()}};var T=function(W){if(h(W.target).is(P)){return}if(w&&!L.options.disabled){L._mouseDownEvent=G;L._mouseUp.call(L,W);w=false;M()}};var S=function(W){if(w&&!L.options.disabled){L._mouseStarted=true;L._mouseMove.call(L,W)}};var R=function(W){if(w&&!L.options.disabled&&W.keyCode===27){L._trigger("stop",W);L._clear()}};var E=function(){h(document).on("mousemove",S);h(Q).on("click",T);h(document).on("click",T);h(document).on("keyup",R)};var M=function(){h(document).off("mousemove",S);h(Q).off("click",T);h(document).off("click",T);h(document).off("keyup",R)};P.click(J)}};var u=function(E){var F=h(".cp-toolbar");var H=F.find("#cp-file-control-annotate");var G=h(".annotationLayer");var D=h(".cp-active-annotation");if(v.isInMode("PRESENTATION")){H.hide();G.hide();D.hide()}else{o(E);H.show();G.show();D.show()}};v.on("fv.showFile",function(D){p=false;u(D)});v.on("fv.changeMode",function(){u(v.getCurrentFile())})};a.showAnnotationsPanel=function(o){var p=o.getView().fileSidebarView;if(!p.isPanelInitialized("annotations")){if(p.isAnyPanelInitialized()){p.teardownPanel()}p.initializePanel("annotations")}k.trigger("ic-jim-async-supported")};return a});(function(){var a=require("cp/component/annotation/annotation-plugin");var b=require("MediaViewer");b.registerPlugin("annotation",a)})();
}catch(e){WRMCB(e)};