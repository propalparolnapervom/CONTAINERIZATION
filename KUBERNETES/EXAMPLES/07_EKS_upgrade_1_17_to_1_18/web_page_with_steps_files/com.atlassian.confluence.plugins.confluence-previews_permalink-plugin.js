WRMCB=function(e){var c=console;if(c&&c.log&&c.error){c.log('Error running batched script.');c.error(e);}}
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:permalink-plugin', location = '/js/component/permalink/file-router.js' */
define("cp/component/permalink/file-router",["jquery","backbone","confluence/jsUri","cp/component/versions/versions-navigation-plugin","cp/service/files-service"],function(f,m,e,n,c){var h=window.encodeURIComponent;var a=window.decodeURIComponent;var l=window.location;var d=f("#confluence-ui").length>0;var k=AJS.DarkFeatures.isEnabled("previews.sharing.pushstate")&&history.pushState;var g=function(p){var o=p.anchor();return p.path()+p.query()+(o?"#"+o:"")};var j=function(t,u){if(!t){return b()}var y=t.get("ownerId");var s;if(t.isLatestVersion&&!t.isLatestVersion()){s=t.getLatestVersion().get("id")}else{s=t.get("id")}var x=t.get("version");var w=u&&u.get("id");var p=t.get("src");var q=t.get("name");var o;if(!u){o=y?(y+"/"+s):h(p)}else{o=y+"/"+s+"/"+x+"/"+w}var z=q?("/"+h(q)):"";if(k){var v="/"+o+z;var r=new e(window.location.href);r=r.replaceQueryParam("preview",v);return g(r)}else{return"#!/preview/"+o+z}};var b=function(){if(k){var o=new e(window.location.href).deleteQueryParam("preview");return g(o)}else{return""}};var i=m.Router.extend({routes:{"!/preview/:ownerId/:id(/:name)":"handleViewer","!/preview/:ownerId/:id/:version/:commentId(/:replyId)(/:name)":"handleLinkForPin","!/preview/*src":"handleWebLink","":"handleCloseViewer","*path":"handleUrl"},initialize:function(o){if(m.History.started){return}this._enabled=true;this._mediaViewer=o.mediaViewer;this.on("route:handleViewer",function(q,r){this.selectFileById(q,r)});this.on("route:handleLinkForPin",function(r,x,s,u,q){var w=this;var t=this._mediaViewer.getCurrentFile();var v=function(y,z){var A=y.get("annotations");if(A){w._mediaViewer._fileState.trigger("cp.showAnnotations");if(z){w.listenToOnce(A,z,function(){A.selectCommentWithId(u,q)})}else{A.selectCommentWithId(u,q)}}};if(this._mediaViewer.isOpen()&&t&&t.get("ownerId")===r&&t.get("id")===x&&t.get("version")==s){v(t)}else{this.selectFileById(r,x,s).done(function(y){v(y,"sync")})}});this.on("route:handleWebLink",function(q){this.disableListeners();if(!this._mediaViewer.isOpen()){this._mediaViewer.open()}this._mediaViewer.showFileWithSrc(q);this.enableListeners()});var p=function(){if(!k){return}var q=new e(window.location.href);if(q.getQueryParamValue("preview")){f(window).off("popstate",p);if(!this._mediaViewer||!this._mediaViewer.getCurrentFile()){m.history.loadUrl("!/preview"+a(q.getQueryParamValue("preview")))}}else{if(o.mediaViewer.isOpen()){o.mediaViewer.close()}f(window).off("popstate",p).on("popstate",p)}}.bind(this);this.on("route:handleUrl",p);this.on("route:handleCloseViewer",function(){this._mediaViewer.close()});this.enableListeners()},start:function(){if(!m.History.started){m.history.start({pushState:k})}},setEnabled:function(o){this._enabled=o},selectFileById:function(o,r,p){this.disableListeners();if(!this._mediaViewer.isOpen()){this._mediaViewer.open()}function q(t){this._mediaViewer._fileState.setCurrentWithCID(t.cid);var s;if(!p||p==t.get("version")){s=this._mediaViewer.showFile(t)}else{s=n.showFileForPreviousVersion(this._mediaViewer,t,p)}this.enableListeners();return s}return this._selectFileById(o,r,p).then(q.bind(this)).fail(function(){this._mediaViewer._fileState.setNoCurrent()}.bind(this))},_selectFileById:function(p,u,q){var t=f.Deferred();var s=this.getCollection();var r=s.findWhere({id:u,ownerId:p});if(r){t.resolve(r)}else{var o=new c(p);o.getFilesWithId([u]).then(function(v){s.add(v);var w=s.findWhere({id:u,ownerId:p});if(w){t.resolve(w)}else{t.reject()}})}return t},getCollection:function(){return this._mediaViewer._fileState.collection},enableListeners:function(){this.listenTo(this._mediaViewer,"fv.changeFile fv.close",this._setRoute);this.listenTo(this._mediaViewer.getView().fileSidebarView,"initializePanel",this._setRouteOnSidebarOpen);this.listenTo(this._mediaViewer.getView().fileSidebarView,"teardownPanel",this._setRouteOnSidebarClose)},disableListeners:function(){this.stopListening(this._mediaViewer,"fv.changeFile fv.close",this._setRoute);this.stopListening(this._mediaViewer.getView().fileSidebarView,"initializePanel",this._setRouteOnSidebarOpen);this.stopListening(this._mediaViewer.getView().fileSidebarView,"teardownPanel",this._setRouteOnSidebarClose)},_setRoute:function(t,o,q){if(this._enabled){var p=j(t,o);var r=!p||(k&&!a(new e(p).getQueryParamValue("preview")));var s=!!o||q||(t&&t.isLatestVersion&&!t.isLatestVersion());this.navigate(p,{trigger:r,replace:s});if(d&&l.pathname+l.search+l.hash!==p&&this._mediaViewer&&this._mediaViewer.__willReopen!==true&&k){window.history.replaceState({},"",p)}}},_setRouteOnSidebarOpen:function(q){if("annotations"===q){var p=this._mediaViewer.getCurrentFile();var o=p.get("annotations").getCurrent();o&&this._setRoute(p,o)}},_setRouteOnSidebarClose:function(o){if("annotations"===o){this._setRoute(this._mediaViewer.getCurrentFile(),null,true)}}});return i});
}catch(e){WRMCB(e)};
;
try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-previews:permalink-plugin', location = '/js/component/permalink/permalink-plugin.js' */
define("cp/component/permalink/permalink-plugin",["MediaViewer","cp/component/permalink/file-router"],function(b,d){var a;var c=function(e){if(!e.getConfig().enablePermalinks){return}a=new d({mediaViewer:e})};c.setRoutingEnabled=function(e){if(a){a.setEnabled(e)}};c.startRouting=function(){if(a){a.start()}};c.setRouteForPin=function(f,e){if(a){a._setRoute(f,e)}};return c});(function(){var a=require("cp/component/permalink/permalink-plugin");var b=require("MediaViewer");b.registerPlugin("permalink",a)})();
}catch(e){WRMCB(e)};